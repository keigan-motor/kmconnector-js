<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"KMStructures.js.html":{"id":"KMStructures.js.html","title":"Source: KMStructures.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMStructures.js /*** * KMStructures.js * var 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let KMUtl = require('./KMUtl'); /** * @classdesc 構造体の基底クラス * @ignore */ class KMStructureBase{ constructor(){ } /** * 同じ値を持つかの比較 * @param {object} tar 比較する構造体 * @returns {boolean} 結果 */ EQ (tar) { if(! tar ){return false;} if(this.constructor===tar.constructor){ if(this.GetValArray){ return this.GetValArray().toString()===tar.GetValArray().toString(); }else if(this.GetValObj){ return JSON.stringify(this.GetValObj())===JSON.stringify(tar.GetValObj());// bad::遅い } } return false; } /** * 複製 * @returns {object} 複製された構造体 */ Clone () { return Object.assign(new this.constructor(),this); } /** * 値の取得（Obj） * @returns {object} */ GetValObj () { return Object.assign({},this); } /** * 値の取得（配列） * @returns {Array} */ GetValArray () { let k=Object.keys(this); let r=[]; for(let i=0;i&lt;k.length;i++){ r.push(this[k[i]]); } return r; } } /** * @classdesc XY座標の構造体オブジェクト * @ignore */ class KMVector2 extends KMStructureBase { /** * constructor * @extends KMStructureBase * @param {number} x * @param {number} y * * @instance */ constructor (x=0, y=0) { super(); this.x = x; this.y = y; } /** * 相対位置へ移動 * @param {number} dx * @param {number} dy */ Move (dx =0, dy = 0) { this.x += dx; this.y += dy; } /** * 2点間の距離 * @param {KMVector2} vector2 * @returns {number} */ Distance (vector2) { if (!(vector2 instanceof KMVector2)) {return;} return Math.sqrt(Math.pow((this.x-vector2.x),2) + Math.pow((this.y-vector2.y),2)); } /** * 2点間の角度 * @param {KMVector2} vector2 * @returns {number} */ Radian (vector2) { if (!(vector2 instanceof KMVector2)) {return;} return Math.atan2(this.y-vector2.y,this.x-vector2.x); } /** * 0,0からの距離 * @returns {number} */ DistanceFromZero() { return Math.sqrt(Math.pow(this.x,2) + Math.pow(this.y,2)); } /** * 0,0からの角度 * @returns {number} radian */ RadianFromZero() { return Math.atan2(this.y,this.x); } } // /** // * @classdesc XYZ 3次元ベクトル // */ // class KMVector3 extends KMStructureBase { // /** // * // * @param x // * @param y // * @param z // */ // constructor(x,y,z) { // super(); // this.x = x?x:0; // this.y = y?y:0; // this.z = z?z:0; // } // /** // * 相対位置へ移動 // * @param {number} dx // * @param {number} dy // * @param {number} dz // * @constructor // */ // Move (dx, dy, dz) { // this.x += dx; // this.y += dy; // this.z += dz; // } // /** // * 2点間の距離 // * @param {KMVector3} vector3 // * @returns {number} // * @constructor // */ // Distance (vector3) { // if (!(vector3 instanceof KMVector3)) {return;} // return Math.sqrt(Math.pow((this.x-vector3.x),2) + Math.pow((this.y-vector3.y),2)+ Math.pow((this.z-vector3.z),2)); // } // // /** // // * 2点間の角度(回転方向の情報なし) // // * @param {KMVector3} vector3 // // * @returns {number} // // * @constructor // // */ // // Radian (vector3) { // // if (!(vector3 instanceof KMVector3)) {return;} // // //todo::2点間の角度(回転方向の情報なし) // // } // /** // * 0,0,0からの距離 // * @returns {number} // * @constructor // */ // DistanceFromZero () { // return Math.sqrt(Math.pow(this.x,2) + Math.pow(this.y,2)+ Math.pow(this.z,2)); // } // // // /** // // * 0,0,0からの角度 // // * @returns {number} radian // // * @constructor // // */ // // RadianFromZero () { // // //todo::0,0,0からの角度 // // } // } /** * @classdesc ジャイロセンサー値 */ class KMImuState extends KMStructureBase { /** * constructor * @extends KMStructureBase * @param {number} accelX 加速度(x) [± 1] * @param {number} accelY 加速度(y) [± 1] * @param {number} accelZ 加速度(z) [± 1] * @param {number} temp 温度 C * @param {number} gyroX 角速度(x) [± 1] * @param {number} gyroY 角速度(y) [± 1] * @param {number} gyroZ 角速度(z) [± 1] * @instance */ constructor (accelX, accelY, accelZ, temp, gyroX, gyroY, gyroZ ) { super(); this.accelX= KMUtl.toNumber(accelX); this.accelY= KMUtl.toNumber(accelY); this.accelZ= KMUtl.toNumber(accelZ); this.temp= KMUtl.toNumber(temp); this.gyroX= KMUtl.toNumber(gyroX); this.gyroY= KMUtl.toNumber(gyroY); this.gyroZ= KMUtl.toNumber(gyroZ); } } /** * KEIGANモーターLED 点灯・色状態 * State MOTOR_LED_STATE * colorR 0-255 * colorG 0-255 * colorB 0-255 * */ /** * @classdesc モーターLED 点灯・色状態 */ class KMLedState extends KMStructureBase { /** * モーターのLED状態 * @readonly * @enum {number} * @property {number} MOTOR_LED_STATE_OFF - 0:LED消灯 * @property {number} MOTOR_LED_STATE_ON_SOLID - 1:LED点灯 * @property {number} MOTOR_LED_STATE_ON_FLASH - 2:LED点滅（一定間隔で点滅） * @property {number} MOTOR_LED_STATE_ON_DIM - 3:LEDがゆっくり輝度変化する */ static get MOTOR_LED_STATE(){ return{ &quot;MOTOR_LED_STATE_OFF&quot;:0, &quot;MOTOR_LED_STATE_ON_SOLID&quot;:1, &quot;MOTOR_LED_STATE_ON_FLASH&quot;:2, &quot;MOTOR_LED_STATE_ON_DIM&quot;:3 } } /** * constructor * @extends KMStructureBase * @param {KMLedState.MOTOR_LED_STATE} state * @param {number} colorR int [0-255] * @param {number} colorG int [0-255] * @param {number} colorB int [0-255] * @instance */ constructor(state,colorR,colorG,colorB) { super(); this.state=KMUtl.toNumber(state); this.colorR=KMUtl.toNumber(colorR); this.colorG=KMUtl.toNumber(colorG); this.colorB=KMUtl.toNumber(colorB); } } /** * @classdesc モーター回転情報 */ class KMRotState extends KMStructureBase { /** * 最大トルク定数 * @readonly * @type {number} */ static get MAX_TORQUE(){ return 0.3;//0.3 N・m } /** * 最大速度定数(rpm) * @readonly * @type {number} */ static get MAX_SPEED_RPM(){ return 300;//300rpm } /** * 最大速度定数(radian/sec) * @readonly * @type {number} */ static get MAX_SPEED_RADIAN(){ return KMUtl.rpmToRadianSec(300); } /** * 最大座標定数 * @readonly * @type {number} */ static get MAX_POSITION(){ return 3*Math.pow(10,38);//info::「return 3e+38」はminifyでエラー //return 3e+38;//radian 4byte float 1.175494 10-38 &lt; 3.402823 10+38 } /** * constructor * @extends KMStructureBase * @param {number} position 座標 * @param {number} velocity 速度 * @param {number} torque トルク * @instance */ constructor(position, velocity, torque) { //有効桁数 小数第3位 super(); this.position = Math.floor(KMUtl.toNumber(position)*100)/100; this.velocity = Math.floor(KMUtl.toNumber(velocity)*100)/100; this.torque = Math.floor(KMUtl.toNumber(torque)*10000)/10000; } } /** * @classdesc デバイス情報 */ class KMDeviceInfo extends KMStructureBase { /** * constructor * @extends KMStructureBase * @param {KMMotorCommandKMOne.KM_CONNECT_TYPE} type 接続方式 * @param {string} id デバイスUUID * @param {string} name モーター名 * @param {boolean} isConnect 接続状態 * @param {string} manufacturerName 製造会社名 * @param {string} hardwareRevision * @param {string} firmwareRevision * @instance */ constructor(type=0,id=&quot;&quot;,name=&quot;&quot;,isConnect=false,manufacturerName=null,hardwareRevision=null,firmwareRevision=null) { super(); this.type=type; this.id=id; this.name=name; this.isConnect=isConnect; this.manufacturerName=manufacturerName; this.hardwareRevision=hardwareRevision; this.firmwareRevision=firmwareRevision; } } module.exports = { KMStructureBase:KMStructureBase, KMVector2:KMVector2, //KMVector3:KMVector3, KMImuState:KMImuState, KMLedState:KMLedState, KMRotState:KMRotState, KMDeviceInfo:KMDeviceInfo }; × Search results Close "},"KMComBLE.js.html":{"id":"KMComBLE.js.html","title":"Source: KMComBLE.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMComBLE.js /*** * KMComBLE.js * version 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let KMUtl = require('./KMUtl'); let KMComBase = require('./KMComBase'); //let noble = require('noble'); let _bleConnectSendingQue=Promise.resolve(true); /** * @classdesc node.js用BLE通信クラス(noble依存) * @ignore */ class KMComBLE extends KMComBase{ /******************************************** * 定数 ********************************************/ /** * サービスUUID * nobleはハイフン無しの文字列 * @readonly * @type {string} * @ignore */ static get MOTOR_BLE_SERVICE_UUID(){ return 'f140ea3589364d35a0eddfcd795baa8c'; } /** * キャラクタリスティクスUUID * @readonly * @enum {string} * @property {string} MOTOR_CONTROL モーターへの設定、制御命令を取り扱う * @property {string} MOTOR_MEASUREMENT モーターの位置・速度・トルク等測定値を取り扱う * @property {string} MOTOR_IMU_MEASUREMENT モーターの加速度・ジャイロセンサー（IMU）を取り扱う * @property {string} MOTOR_SETTING モーターの設定値を取り扱う * @ignore */ static get MOTOR_BLE_CRS(){ return { 'MOTOR_CONTROL':'f140000189364d35a0eddfcd795baa8c',// //'MOTOR_LED':'f140000389364d35a0eddfcd795baa8c',//モーターのLEDを取り扱う info:: MOTOR_CONTROL::bleLedで代用 'MOTOR_MEASUREMENT':'f140000489364d35a0eddfcd795baa8c',// 'MOTOR_IMU_MEASUREMENT':'f140000589364d35a0eddfcd795baa8c',// 'MOTOR_SETTING':'f140000689364d35a0eddfcd795baa8c'// }; } /** * Device Information Service * @readonly * @enum {string} * @property {string} Service * @property {string} ManufacturerNameString * @property {string} HardwareRevisionString * @property {string} FirmwareRevisionString * @ignore */ static get DEVICE_INFORMATION_SERVICE_UUIDS(){ return { &quot;Service&quot;:&quot;180a&quot; ,&quot;ManufacturerNameString&quot;:&quot;2a29&quot; ,&quot;HardwareRevisionString&quot;:&quot;2a27&quot; ,&quot;FirmwareRevisionString&quot;:&quot;2a26&quot; }; } /******************************************** * section::公開メソッド ********************************************/ /** * constructor * @param {object} peripheral noble peripheral object * */ constructor(peripheral){ super(); //todo::peripheral.constructor.name!=='‌Peripheral' 比較出来ない。常にtrue? if(!peripheral instanceof Object||!peripheral.uuid){ throw new Error('Type mismatch of peripheral device'); } this._peripheral=peripheral; this._characteristics={}; this._bleSendingQue=Promise.resolve(true); //this._queCount=0; this._deviceInfo.type=&quot;BLE&quot;; this._deviceInfo.id=this._peripheral.id; this._deviceInfo.name=peripheral.advertisement?peripheral.advertisement.localName:null; /******************************************** * イベント ********************************************/ this._peripheral.removeAllListeners('connect'); this._peripheral.removeAllListeners('disconnect'); this._peripheral.removeAllListeners('servicesDiscover'); this._peripheral.on('connect', function() { console.log('connect'); this._statusChange_isConnect(true); }.bind(this)); this._peripheral.on('disconnect', function(){ console.log('disconnect'); this._statusChange_isConnect(false); }.bind(this)); } /** * BLEでの接続を開始する * */ connect(){ //info::インスタンス毎に並列で処理すると接続出来ない事がある為、キューに溜めて逐次処理 _bleConnectSendingQue= _bleConnectSendingQue.then((res)=&gt;{ return new Promise((resolve,reject)=&gt; { if (this._peripheral&amp;&amp; this._peripheral.state==='connected') { resolve(true);return; } this._peripheral.connect(function(error){ if(error){ this._onConnectFailureHandler(this,error); resolve(error); }else if(!this._isInit){ this._discoverServices().then(()=&gt;{ resolve(true); }).catch(function(res){ resolve(true); }); // this._peripheral.discoverServices([this.constructor.MOTOR_BLE_SERVICE_UUID,this.constructor.DEVICE_INFORMATION_SERVICE_UUIDS.Service]); }else { resolve(true); } }.bind(this)); }).catch(function(res){ resolve(true); }); }); } /** * BLEでの切断 */ disConnect(){ //info::キューに溜まっているconnectは切断出来ない this._peripheral.disconnect(); } /******************************************** * 内部 ********************************************/ _discoverServices(){ return new Promise((d_resolve,d_reject)=&gt; { this._peripheral.discoverServices([this.constructor.MOTOR_BLE_SERVICE_UUID,this.constructor.DEVICE_INFORMATION_SERVICE_UUIDS.Service], (error,services)=&gt;{ if(error){ d_reject(error);return; } console.log('servicesDiscover'); let discMotorServiceFlg=false; Promise.all(services.map((service)=&gt;{ return new Promise((svresolve, svreject) =&gt; { if (service['uuid'] === this.constructor.MOTOR_BLE_SERVICE_UUID) { discMotorServiceFlg = true; service.discoverCharacteristics([],(err,characteristics) =&gt;{ if(err){ svreject(errmsg);return; } let crs = {}; Object.keys(this.constructor.MOTOR_BLE_CRS).forEach((key) =&gt; { for (let j = 0; j &lt; characteristics.length; j++) { if (characteristics[j].uuid === this.constructor.MOTOR_BLE_CRS[key]) { crs[key] = characteristics[j]; break; } } }); this._characteristics = crs; //start notify new Promise((resolve, reject) =&gt; { if (this._characteristics['MOTOR_MEASUREMENT']) { this._characteristics['MOTOR_MEASUREMENT'].removeAllListeners('data'); this._characteristics['MOTOR_MEASUREMENT'].on('data', this._onBleMotorMeasurement.bind(this)); this._characteristics['MOTOR_MEASUREMENT'].subscribe((error) =&gt; { if (error) { let errmsg = 'err:MOTOR_MEASUREMENT subscribe -&gt; :' + error; console.log(errmsg); reject(errmsg); } else { resolve(); } }); } }).then(() =&gt; { return new Promise((resolve, reject) =&gt; { if (this._characteristics['MOTOR_IMU_MEASUREMENT']) { this._characteristics['MOTOR_IMU_MEASUREMENT'].removeAllListeners('data'); this._characteristics['MOTOR_IMU_MEASUREMENT'].on('data', this._onBleImuMeasurement.bind(this)); this._characteristics['MOTOR_IMU_MEASUREMENT'].subscribe((error) =&gt; { if (error) { let errmsg = 'err:MOTOR_IMU_MEASUREMENT subscribe -&gt; :' + error; console.log(errmsg); reject(errmsg); } else { resolve(); } }); } }); }).then(() =&gt; { return new Promise((resolve, reject) =&gt; { if (this._characteristics['MOTOR_SETTING']) { this._characteristics['MOTOR_SETTING'].removeAllListeners('data'); this._characteristics['MOTOR_SETTING'].on('data', this._onBleMotorSetting.bind(this)); this._characteristics['MOTOR_SETTING'].subscribe((error) =&gt; { if (error) { let errmsg = 'err:MOTOR_SETTING subscribe -&gt; :' + error; console.log(errmsg); reject(errmsg); } else { resolve(); } }); } }); }).then(() =&gt; { svresolve(true); }).catch((errmsg) =&gt; { console.log(errmsg); svreject(errmsg); }); }); } else if (service['uuid'] === this.constructor.DEVICE_INFORMATION_SERVICE_UUIDS.Service) { service.discoverCharacteristics([], (err,characteristics) =&gt;{ if(err){ svreject(errmsg);return; } Promise.all(characteristics.map((characteristic)=&gt;{ return new Promise((resolve, reject)=&gt;{ switch (characteristic.uuid) { case this.constructor.DEVICE_INFORMATION_SERVICE_UUIDS.ManufacturerNameString: characteristic.read((error, data) =&gt; { this._deviceInfo.manufacturerName = KMUtl.Utf8ArrayToStr(data); resolve(true); }); break; case this.constructor.DEVICE_INFORMATION_SERVICE_UUIDS.HardwareRevisionString: characteristic.read((error, data) =&gt; { this._deviceInfo.hardwareRevision = KMUtl.Utf8ArrayToStr(data); resolve(true); }); break; case this.constructor.DEVICE_INFORMATION_SERVICE_UUIDS.FirmwareRevisionString: characteristic.read((error, data) =&gt; { this._deviceInfo.firmwareRevision = KMUtl.Utf8ArrayToStr(data); resolve(true); }); break; default: resolve(true); break; } }); })).then(()=&gt;{ svresolve(true); }).catch((errmsg)=&gt;{ svreject(errmsg); }); }); }else{ svresolve(true); } }); })).then(()=&gt;{ if(!discMotorServiceFlg){ console.log('Type mismatch of motor peripheral device:'+this._deviceInfo.name); this._peripheral.disconnect(); }else{ this._statusChange_init(true); this._statusChange_isConnect(true);//初回のみ(comp以前は発火しない為) d_resolve(true); } }).catch((errmsg)=&gt;{ console.log('Err servicesDiscover:'+errmsg); d_resolve(true); }); }); }); } /** * @#--------------------------------------------------------- * @summary モーター回転情報受信 * @param {Buffer} data * @private * @# * --------------------------------------------------------- * Notify したときの返り値 * byte[0]-byte[3] byte[4]-byte[7] byte[8]-byte[11] * float * float * float * * position:radians speed:radians/second torque:N・m */ _onBleMotorMeasurement(data){ if(! data instanceof Buffer){return;} let u8=new Uint8Array(data);//info::一旦コピーする必要がある https://stackoverflow.com/questions/37794803/node-js-buffer-to-typed-array let dv=new DataView(u8.buffer); let res={position:dv.getFloat32(0,false),velocity:dv.getFloat32(4,false),torque:dv.getFloat32(8,false)}; this._onMotorMeasurementCB(res); } /** * @#--------------------------------------------------------- * @summary モーターIMU情報受信 * @param {Buffer} data * @private * * @# Notify したときの返り値)--------------------------------------------- * * accel_x, accel_y, accel_z, temp, gyro_x, gyro_y, gyro_z が全て返ってくる。取得間隔は100ms 固定 * byte(BigEndian) [0][1] [2][3] [4][5] [6][7] [8][9] [10][11] [12][13] * int16_t int16_t int16_t int16_t int16_t int16_t int16_t * accel-x accel-y accel-z temp gyro-x gyro-y gyro-z * * int16_t:-32,768〜32,768 * 机の上にモーターを置いた場合、加速度 z = 16000 程度となる。（重力方向のため） * * 単位変換）--------------------------------------------------------- * 加速度 value [G] = raw_value * 2 / 32,767 * 温度 value [℃] = raw_value / 333.87 + 21.00 * 角速度 * value [degree/second] = raw_value * 250 / 32,767 * value [radians/second] = raw_value * 0.00013316211 * */ _onBleImuMeasurement(data){ if(! data instanceof Buffer){return;} let u8=new Uint8Array(data);//info::一旦コピーする必要がある let dv=new DataView(u8.buffer); let tempCalibration=-5.7;//温度校正値 //単位を扱い易いように変換 let res={ accelX:dv.getInt16(0,false)*2/32767,accelY:dv.getInt16(2,false)*2/32767,accelZ:dv.getInt16(4,false)*2/32767, temp:(dv.getInt16(6,false)) / 333.87 + 21.00+tempCalibration, gyroX:dv.getInt16(8,false)*250/32767,gyroY:dv.getInt16(10,false)*250/32767,gyroZ:dv.getInt16(12,false)*250/32767 }; // console.log(res); this._onImuMeasurementCB(res); } /** * @#--------------------------------------------------------- * モーター設定情報取得 * @param {Buffer} data * @private * @#--------------------------------------------------------- * Notify したときの返り値 * byte[0] byte[1] byte[2] byte[3] byte[4]以降 byte[n-2] byte[n-1] * uint8_t:log_type uint16_t:id uint8_t:register uint8_t:value uint16_t:CRC * 0x40 uint16_t (2byte) 0～65535 レジスタコマンド レジスタの値（コマンドによって変わる） uint16_t (2byte) 0～65535 */ _onBleMotorSetting(data){ if(! data instanceof Buffer){return;} let u8=new Uint8Array(data);//info::一旦コピーする必要がある let dv=new DataView(u8.buffer);//6+nバイト データ仕様 https://docs.google.com/spreadsheets/d/1uxJu86Xe8KbIlxu5oPFv9KQdvHY33-NIy0cdSgInoUk/edit#gid=1000482383 //------------- //データのparse //------------- let notifyBinLen=dv.byteLength; let notifyCmd=dv.getUint8(0);//レジスタ情報通知コマンドID 0x40固定 if(notifyCmd!==0x40||notifyBinLen&lt;=6){return;}//レジスタ情報を含まないデータの破棄 let id=dv.getUint16(1,false);//送信ID let registerCmd=dv.getUint8(3);//レジスタコマンド let crc=dv.getUint16(notifyBinLen-2,false);//CRCの値 最後から2dyte let res={}; //コマンド別によるレジスタの値の取得[4-n byte] switch(registerCmd){ case this._MOTOR_SETTING_READREGISTER_COMMAND.maxSpeed: res.maxSpeed=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.minSpeed: res.minSpeed=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.curveType: res.curveType=dv.getUint8(4); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.acc: res.acc=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.dec: res.dec=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.maxTorque: res.maxTorque=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.qCurrentP: res.qCurrentP=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.qCurrentI: res.qCurrentI=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.qCurrentD: res.qCurrentD=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.speedP: res.speedP=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.speedI: res.speedI=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.speedD: res.speedD=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.positionP: res.positionP=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.ownColor: res.ownColor=('#000000' +Number(dv.getUint8(4)&lt;&lt;16|dv.getUint8(5)&lt;&lt;8|dv.getUint8(6)).toString(16)).substr(-6); break; } //console.log(res); this._onMotorSettingCB(registerCmd,res); } /** * BLEコマンドの送信 * @param commandCategory コマンド種別のString 主にBLEのキャラクタリスティクスで使用する * @param commandNum * @param arraybuffer * @param notifyPromis cmdReadRegister等のBLE呼び出し後にnotifyで取得する値をPromisで帰す必要のあるコマンド用 * @private * @#--------------------------------------------------------- */ _sendMotorCommand(commandCategory, commandNum, arraybuffer=new ArrayBuffer(0), notifyPromis=null){ let characteristics=this._characteristics[commandCategory]; let ab=new DataView(arraybuffer); //コマンド・ID・CRCの付加 let buffer = new ArrayBuffer(arraybuffer.byteLength+5); new DataView(buffer).setUint8(0,commandNum); new DataView(buffer).setUint16(1,this.createCommandID); new DataView(buffer).setUint16(arraybuffer.byteLength+3,0); //データの書き込み for(let i=0;i&lt;arraybuffer.byteLength;i++){ new DataView(buffer).setUint8(3+i,ab.getUint8(i)); } //queに追加 // ++this._queCount; this._bleSendingQue= this._bleSendingQue.then((res)=&gt;{ // console.log(&quot;_sendMotorCommand queCount:&quot;+(--this._queCount)); if(notifyPromis){ notifyPromis.startRejectTimeOutCount(); } return new Promise((resolve,reject)=&gt; { characteristics.write(this._toBuffer(buffer), true,//withoutResponseFlg function(error){ if(!error){ resolve(true); }else{ reject(&quot;ERR:characteristics.write&quot;); } }); }) }).catch(function(res){ //失敗時 //info::後続のコマンドは引き続き実行される //console.log(&quot;ERR _sendMotorCommand:&quot;+res+&quot; queCount:&quot;+(--this._queCount)); if(notifyPromis){ notifyPromis.callReject(res); } }); } /** * ArrayBuffer to Buffer * @param ab * @returns {Buffer} * @private */ _toBuffer(ab) { let buf = new Buffer(ab.byteLength); let view = new Uint8Array(ab); for (let i = 0; i &lt; buf.length; ++i) { buf[i] = view[i]; } return buf; } //////class// } module.exports =KMComBLE; × Search results Close "},"KMComBase.js.html":{"id":"KMComBase.js.html","title":"Source: KMComBase.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMComBase.js /*** * KMComBase.js * version 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let KMUtl = require('./KMUtl'); let KMStructures=require('./KMStructures'); /** * @classdesc 通信クラスの基底 * @ignore */ class KMComBase{ /********************** * 定数 **********************/ /** * constructor */ constructor(){ this._peripheral=null; this._commandCount=0; this._deviceInfo=new KMStructures.KMDeviceInfo(); this._motorMeasurement=new KMStructures.KMRotState(); this._motorLed=new KMStructures.KMLedState(); this._motorImuMeasurement=new KMStructures.KMImuState(); this._onInitHandler=function(connector){}; this._onConnectHandler=function(connector){}; this._onDisconnectHandler=function(connector){}; this._onConnectFailureHandler=function(connector, msg){}; this._onMotorMeasurementCB=function(){}; this._onImuMeasurementCB=function(){}; this._onMotorSettingCB=function(){}; this._isInit=false; /** * _onBleMotorSettingのコマンド モーター設定情報の通知受信時にパースする用 * @type {{maxSpeed: number, minSpeed: number, curveType: number, acc: number, dec: number, maxTorque: number, qCurrentP: number, qCurrentI: number, qCurrentD: number, speedP: number, speedI: number, speedD: number, positionP: number, ownColor: number}} * @ignore */ this._MOTOR_SETTING_READREGISTER_COMMAND={ &quot;maxSpeed&quot;:0x02, &quot;minSpeed&quot;:0x03, &quot;curveType&quot;:0x05, &quot;acc&quot;:0x07, &quot;dec&quot;:0x08, &quot;maxTorque&quot;:0x0E, &quot;qCurrentP&quot;:0x18, &quot;qCurrentI&quot;:0x19, &quot;qCurrentD&quot;:0x1A, &quot;speedP&quot;:0x1B, &quot;speedI&quot;:0x1C, &quot;speedD&quot;:0x1D, &quot;positionP&quot;:0x1E, &quot;ownColor&quot;:0x3A } } /********************** * プロパティ **********************/ /** * デバイス情報 * @type {KMDeviceInfo} * */ get deviceInfo(){ return this._deviceInfo.Clone(); } /** * 有効無効 * @type {boolean} */ get isConnect(){ return this._deviceInfo.isConnect; } /** * モーターコマンド順監視用連番の発行 * @type {number} */ get createCommandID(){ return this._commandCount=(++this._commandCount)&amp;0b1111111111111111;//65535でループ } /** * isConnectの設定変更(子クラスから使用) * @param {boolean} bool * @ignore */ _statusChange_isConnect(bool){ this._deviceInfo.isConnect=bool; if(this._isInit){ if(bool){ this._onConnectHandler(this); }else{ this._onDisconnectHandler(this); } } } /** * 初期化状態の設定(子クラスから使用) * @param {boolean} bool * @ignore */ _statusChange_init(bool){ this._isInit=bool; if(this._isInit){ this._onInitHandler(this); } } /********************** * callback **********************/ /** * 初期化完了して利用できるようになった * @type {function(KMComBase)} */ set onInit(handlerFunction){ if(typeof handlerFunction ===&quot;function&quot;){ this._onInitHandler=handlerFunction; } } /** * 応答・再接続に成功した * @type {function(KMComBase)} */ set onConnect(handlerFunction){ if(typeof handlerFunction ===&quot;function&quot;){ this._onConnectHandler=handlerFunction; } } /** * 応答が無くなった・切断された * @type {function(KMComBase)} */ set onDisconnect(handlerFunction){ if(typeof handlerFunction ===&quot;function&quot;){ this._onDisconnectHandler=handlerFunction; } } /** * 接続に失敗 * @type {function(KMComBase,string)} */ set onConnectFailure(handlerFunction){ if(typeof handlerFunction ===&quot;function&quot;){ this._onConnectFailureHandler=handlerFunction; } } /** * モーターの回転情報callback * @type {function(position:number,velocity:number,torque:number)} */ set onMotorMeasurement(func){ if(typeof func===&quot;function&quot;){ this._onMotorMeasurementCB=func; } } /** * モーターのジャイロ情報callback * @type {function({accelX:number,accelY:number,accelZ:number,temp:number,gyroX:number,gyroY:number,gyroZ:number})} */ set onImuMeasurement(func){ if(typeof func===&quot;function&quot;){ this._onImuMeasurementCB=func; } } /** * モーター設定情報取得callback * @type {function(registerCmd:number,res:number)} */ set onMotorSetting(func){ if(typeof func===&quot;function&quot;){ this._onMotorSettingCB=func; } } //////class// } module.exports =KMComBase; × Search results Close "},"KMComWebBLE.js.html":{"id":"KMComWebBLE.js.html","title":"Source: KMComWebBLE.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMComWebBLE.js /*** * KMComWebBLE.js * version 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let KMUtl = require('./KMUtl'); let KMComBase = require('./KMComBase'); /** * @classdesc ブラウザ用WebBluetooh通信クラス(chrome依存) * @ignore */ class KMComWebBLE extends KMComBase{ /******************************************** * 定数 ********************************************/ /** * constructor */ constructor(){ super(); this._deviceInfo.type=&quot;WEBBLE&quot;; this._characteristics={}; this._bleSendingQue=Promise.resolve(true); this._queCount=0; //サービスUUID this._MOTOR_BLE_SERVICE_UUID='f140ea35-8936-4d35-a0ed-dfcd795baa8c'; //キャラクタリスティクスUUID this._MOTOR_BLE_CRS={ 'MOTOR_CONTROL':'f1400001-8936-4d35-a0ed-dfcd795baa8c',//モーターへの設定、制御命令を取り扱う //'MOTOR_LED':'f1400003-8936-4d35-a0ed-dfcd795baa8c',//モーターのLEDを取り扱う info:: MOTOR_CONTROL::bleLedで代用 'MOTOR_MEASUREMENT':'f1400004-8936-4d35-a0ed-dfcd795baa8c',//モーターの位置・速度・トルク等測定値を取り扱う 'MOTOR_IMU_MEASUREMENT':'f1400005-8936-4d35-a0ed-dfcd795baa8c',//モーターの加速度・ジャイロセンサー（IMU）を取り扱う 'MOTOR_SETTING':'f1400006-8936-4d35-a0ed-dfcd795baa8c'//モーターの設定値を取り扱う }; this._DEVICE_INFORMATION_SERVICE_UUIDS={ &quot;Service&quot;:0x180a ,&quot;ManufacturerNameString&quot;:0x2a29 ,&quot;HardwareRevisionString&quot;:0x2a27 ,&quot;FirmwareRevisionString&quot;:0x2a26 }; /** * BLE切断時 * @param eve * @private */ this._onBleConnectionLost=(eve)=&gt;{ this._deviceInfo.isConnect=false; this._peripheral=null; this._statusChange_isConnect(false); }; /** * @#--------------------------------------------------------- * モーター回転情報受信 * @param eve * @private * @#--------------------------------------------------------- * Notify したときの返り値 * byte[0]-byte[3] byte[4]-byte[7] byte[8]-byte[11] * float * float * float * * position:radians speed:radians/second torque:N・m */ this._onBleMotorMeasurement=(eve)=&gt;{ if(!eve||!eve.target){return;} let dv = eve.target.value; if(!(dv instanceof DataView)){return;}//info::web bluetoohのみ node.jsはinstanceof Buffer let res={position:dv.getFloat32(0,false),velocity:dv.getFloat32(4,false),torque:dv.getFloat32(8,false)}; this._onMotorMeasurementCB(res); }; /** * @#--------------------------------------------------------- * モーターIMU情報受信 * @param eve * @private * * @#Notify したときの返り値)--------------------------------------------- * * accel_x, accel_y, accel_z, temp, gyro_x, gyro_y, gyro_z が全て返ってくる。取得間隔は100ms 固定 * byte(BigEndian) [0][1] [2][3] [4][5] [6][7] [8][9] [10][11] [12][13] * int16_t int16_t int16_t int16_t int16_t int16_t int16_t * accel-x accel-y accel-z temp gyro-x gyro-y gyro-z * * int16_t:-32,768〜32,768 * 机の上にモーターを置いた場合、加速度 z = 16000 程度となる。（重力方向のため） * * 単位変換）--------------------------------------------------------- * 加速度 value [G] = raw_value * 2 / 32,767 * 温度 value [℃] = raw_value / 333.87 + 21.00 * 角速度 * value [degree/second] = raw_value * 250 / 32,767 * value [radians/second] = raw_value * 0.00013316211 * */ this._onBleImuMeasurement=(eve)=&gt;{ if(!eve||!eve.target){return;} let dv = eve.target.value; let tempCalibration=-5.7;//温度校正値 if(!(dv instanceof DataView)){return;}//info::web bluetoohのみ node.jsはinstanceof Buffer //単位を扱い易いように変換 let res={ accelX:dv.getInt16(0,false)*2/32767,accelY:dv.getInt16(2,false)*2/32767,accelZ:dv.getInt16(4,false)*2/32767, temp:(dv.getInt16(6,false)) / 333.87 + 21.00+tempCalibration, gyroX:dv.getInt16(8,false)*250/32767,gyroY:dv.getInt16(10,false)*250/32767,gyroZ:dv.getInt16(12,false)*250/32767 }; // console.log(res); this._onImuMeasurementCB(res); }; /** * @#--------------------------------------------------------- * モーター設定情報取得 * @param eve * @private * @#--------------------------------------------------------- * Notify したときの返り値 * byte[0] byte[1] byte[2] byte[3] byte[4]以降 byte[n-2] byte[n-1] * uint8_t:log_type uint16_t:id uint8_t:register uint8_t:value uint16_t:CRC * 0x40 uint16_t (2byte) 0～65535 レジスタコマンド レジスタの値（コマンドによって変わる） uint16_t (2byte) 0～65535 */ this._onBleMotorSetting=(eve)=&gt;{ if(!eve||!eve.target){return;} let dv = eve.target.value;//6+nバイト データ仕様 https://docs.google.com/spreadsheets/d/1uxJu86Xe8KbIlxu5oPFv9KQdvHY33-NIy0cdSgInoUk/edit#gid=1000482383 if(!(dv instanceof DataView)){return;}//info::web bluetoohのみ node.jsはinstanceof Buffer //------------- //データのparse //------------- let notifyBinLen=dv.byteLength; let notifyCmd=dv.getUint8(0);//レジスタ情報通知コマンドID 0x40固定 if(notifyCmd!=0x40||notifyBinLen&lt;=6){return;}//レジスタ情報を含まないデータの破棄 let id=dv.getUint16(1,false);//送信ID let registerCmd=dv.getUint8(3);//レジスタコマンド let crc=dv.getUint16(notifyBinLen-2,false);//CRCの値 最後から2dyte let res={}; //コマンド別によるレジスタの値の取得[4-n byte] switch(registerCmd){ case this._MOTOR_SETTING_READREGISTER_COMMAND.maxSpeed: res.maxSpeed=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.minSpeed: res.minSpeed=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.curveType: res.curveType=dv.getUint8(4); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.acc: res.acc=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.dec: res.dec=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.maxTorque: res.maxTorque=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.qCurrentP: res.qCurrentP=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.qCurrentI: res.qCurrentI=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.qCurrentD: res.qCurrentD=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.speedP: res.speedP=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.speedI: res.speedI=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.speedD: res.speedD=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.positionP: res.positionP=dv.getFloat32(4,false); break; case this._MOTOR_SETTING_READREGISTER_COMMAND.ownColor: res.ownColor=('#000000' +Number(dv.getUint8(4)&lt;&lt;16|dv.getUint8(5)&lt;&lt;8|dv.getUint8(6)).toString(16)).substr(-6); break; } //console.log(res); this._onMotorSettingCB(registerCmd,res); } } /******************************************** * section::公開メソッド ********************************************/ /** * WebBluetoohでの接続を開始する */ connect(){ if (this._peripheral&amp;&amp; this._peripheral.gatt&amp;&amp;this._peripheral.gatt.connected ) {return} let gat= (this._peripheral&amp;&amp; this._peripheral.gatt )?this._peripheral.gatt :undefined;//再接続用 this._bleConnect(gat).then(obj=&gt;{//info:: resolve({deviceID,deviceName,bleDevice,characteristics}); this._peripheral=obj.bleDevice; this._deviceInfo.id=this._peripheral.id; this._deviceInfo.name=this._peripheral.name; this._deviceInfo.isConnect=this._peripheral.gatt.connected; this._deviceInfo.manufacturerName=obj.infomation.manufacturerName; this._deviceInfo.hardwareRevision=obj.infomation.hardwareRevision; this._deviceInfo.firmwareRevision=obj.infomation.firmwareRevision; // this._characteristics=obj.characteristics; if(!gat){ this._peripheral.removeEventListener('gattserverdisconnected',this._onBleConnectionLost); this._peripheral.addEventListener('gattserverdisconnected', this._onBleConnectionLost); if(this._characteristics['MOTOR_MEASUREMENT']){ this._characteristics['MOTOR_MEASUREMENT'].removeEventListener('characteristicvaluechanged',this._onBleMotorMeasurement); this._characteristics['MOTOR_MEASUREMENT'].addEventListener('characteristicvaluechanged',this._onBleMotorMeasurement); this._characteristics['MOTOR_MEASUREMENT'].startNotifications().then(obj=&gt;{ if(this._characteristics['MOTOR_IMU_MEASUREMENT']){ this._characteristics['MOTOR_IMU_MEASUREMENT'].removeEventListener('characteristicvaluechanged',this._onBleImuMeasurement); this._characteristics['MOTOR_IMU_MEASUREMENT'].addEventListener('characteristicvaluechanged',this._onBleImuMeasurement); return this._characteristics['MOTOR_IMU_MEASUREMENT'].startNotifications(); } }).then(obj=&gt;{ if(this._characteristics['MOTOR_SETTING']){ this._characteristics['MOTOR_SETTING'].removeEventListener('characteristicvaluechanged',this._onBleMotorSetting); this._characteristics['MOTOR_SETTING'].addEventListener('characteristicvaluechanged',this._onBleMotorSetting); return this._characteristics['MOTOR_SETTING'].startNotifications(); } }).then(obj=&gt;{ this._statusChange_init(true); this._statusChange_isConnect(true);//初回のみ(comp以前は発火しない為) }) } }else { this._statusChange_isConnect(true); } }).catch(err=&gt;{ this._peripheral=null; this._onConnectFailureHandler(this,err); }) } /** * WebBluetoohの切断 */ disConnect(){ if (!this._peripheral || !this._peripheral.gatt.connected){return;} this._peripheral.gatt.disconnect(); this._peripheral=null; } /******************************************** * 内部 ********************************************/ /** * BLE接続 * @param gatt_obj ペアリング済みのGATTのデバイスに再接続用(ペアリングモーダルは出ない) * @returns {Promise} * @private */ _bleConnect(gatt_obj) { //let self = this; return new Promise((resolve, reject)=&gt; { // let bleDevice; // let deviceName; // let deviceID; if(!gatt_obj){ let options = { filters: [{services: [this._MOTOR_BLE_SERVICE_UUID]}], optionalServices:[this._DEVICE_INFORMATION_SERVICE_UUIDS.Service] }; navigator.bluetooth.requestDevice(options) .then(device =&gt; { this._bleGatconnect(device.gatt).then(res =&gt; { resolve({ bleDevice: device, deviceID: device.id, deviceName: device.name, characteristics:res.characteristics, infomation:res.infomation }); }) .catch(error =&gt; { console.log(error); reject(error); }); }) }else{ this._bleGatconnect(gatt_obj) .then(res =&gt; { console.log(&quot;_bleGatconnect&quot;); resolve({ deviceID: gatt_obj.device.id, deviceName: gatt_obj.device.name, bleDevice: gatt_obj.device, characteristics:res.characteristics, infomation:res.infomation }); }) .catch(error =&gt; { console.log(error); reject(error); }); } }); } //GATT接続用 _bleGatconnect(gatt_obj){ let characteristics = {}; let infomation={}; return new Promise((gresolve, greject)=&gt; { gatt_obj.connect().then(server =&gt; { // return server.getPrimaryServices(this._MOTOR_BLE_SERVICE_UUID); server.getPrimaryService(this._MOTOR_BLE_SERVICE_UUID).then(service =&gt; { let crs = []; Object.keys(this._MOTOR_BLE_CRS).forEach((key) =&gt; { crs.push( service.getCharacteristic(this._MOTOR_BLE_CRS[key]) .then(chara =&gt; { characteristics[key] = chara; }) ); }); return Promise.all(crs); }).then(()=&gt;{ //ble_firmware_revisionのサービス取得 info::Androiddでは不安定な為停止 return new Promise((sresolve, sreject)=&gt; { server.getPrimaryService(this._DEVICE_INFORMATION_SERVICE_UUIDS.Service).then((service) =&gt; { Promise.resolve().then(()=&gt;{ return new Promise((resolve, reject)=&gt;{ service.getCharacteristic(this._DEVICE_INFORMATION_SERVICE_UUIDS.ManufacturerNameString) .then(chara =&gt; { return chara.readValue(); }).then(val =&gt; { infomation['manufacturerName'] = KMUtl.Utf8ArrayToStr(new Uint8Array(val.buffer)); resolve(); }).catch((e)=&gt;{reject(e);}) }); }).then(()=&gt;{ return new Promise((resolve, reject)=&gt;{ service.getCharacteristic(this._DEVICE_INFORMATION_SERVICE_UUIDS.FirmwareRevisionString) .then(chara =&gt; { return chara.readValue(); }).then(val =&gt; { infomation['firmwareRevision'] = KMUtl.Utf8ArrayToStr(new Uint8Array(val.buffer)); resolve(); }).catch((e)=&gt;{reject(e);}) }); }).then(()=&gt;{ return new Promise((resolve, reject)=&gt;{ service.getCharacteristic(this._DEVICE_INFORMATION_SERVICE_UUIDS.HardwareRevisionString) .then(chara =&gt; { return chara.readValue(); }).then(val =&gt; { infomation['hardwareRevision'] = KMUtl.Utf8ArrayToStr(new Uint8Array(val.buffer)); resolve(); }).catch((e)=&gt;{reject(e);}) }); }).then(()=&gt;{ sresolve(); }).catch((e)=&gt;{ sreject(e); }) }).catch((e)=&gt;{ sreject(e); }) }); }).then(() =&gt; { gresolve({characteristics: characteristics, infomation: infomation}); }).catch((e)=&gt;{ console.log(e); }) }); }); } /** * BLEコマンドの送信 * @param commandTypeStr 'MOTOR_CONTROL','MOTOR_MEASUREMENT','MOTOR_IMU_MEASUREMENT','MOTOR_SETTING' * コマンド種別のString 主にBLEのキャラクタリスティクスで使用する * @param commandNum * @param arraybuffer * @param notifyPromis cmdReadRegister等のBLE呼び出し後にnotifyで取得する値をPromisで帰す必要のあるコマンド用 * @private */ _sendMotorCommand(commandCategory, commandNum, arraybuffer=new ArrayBuffer(0), notifyPromis=null){ let characteristics=this._characteristics[commandCategory]; let ab=new DataView(arraybuffer); //コマンド・ID・CRCの付加 let buffer = new ArrayBuffer(arraybuffer.byteLength+5); new DataView(buffer).setUint8(0,commandNum); new DataView(buffer).setUint16(1,this.createCommandID); new DataView(buffer).setUint16(arraybuffer.byteLength+3,0); //データの書き込み for(let i=0;i&lt;arraybuffer.byteLength;i++){ new DataView(buffer).setUint8(3+i,ab.getUint8(i)); } //queに追加 // ++this._queCount; this._bleSendingQue= this._bleSendingQue.then((res)=&gt;{ // console.log(&quot;_sendMotorCommand queCount:&quot;+(--this._queCount)); if(notifyPromis){ notifyPromis.startRejectTimeOutCount(); } return characteristics.writeValue(buffer); }).catch(function(res){ //失敗時 //info::後続のコマンドは引き続き実行される // console.log(&quot;ERR _sendMotorCommand:&quot;+res+&quot; queCount:&quot;+(--this._queCount)); if(notifyPromis){ notifyPromis.callReject(res); } }); } //////class// } module.exports =KMComWebBLE; × Search results Close "},"KMMotorCommandKMOne.js.html":{"id":"KMMotorCommandKMOne.js.html","title":"Source: KMMotorCommandKMOne.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMMotorCommandKMOne.js /*** * KMMotorCommandKMOne.js * version 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let EventEmitter = require(&quot;events&quot;).EventEmitter; let KMUtl = require('./KMUtl'); let KMComWebBLE = require('./KMComWebBLE'); let KMStructures=require('./KMStructures'); /** * @classdesc KM1コマンド送信クラス * @ignore */ class KMMotorCommandKMOne extends EventEmitter{ /******************************************** * 定数 ********************************************/ /** * 接続方式定数 * @readonly * @enum {number} * @property {number} WEBBLE - 1:WEBBLE * @property {number} BLE - 2:BLE * @property {number} SERIAL - 3:SERIAL */ static get KM_CONNECT_TYPE(){ return {&quot;WEBBLE&quot;:1,&quot;BLE&quot;:2,&quot;SERIAL&quot;:3}; } /** * cmdPreparePlaybackMotionの開始位置オプション定数 * @readonly * @enum {number} * @property {number} START_POSITION_ABS - 0:記憶された開始位置（絶対座標）からスタート * @property {number} START_POSITION_CURRENT - 1:現在の位置を開始位置としてスタート */ static get cmdPreparePlaybackMotion_START_POSITION(){ return{ 'START_POSITION_ABS':0, 'START_POSITION_CURRENT':1 }; } /** * cmdLedのLEDの点灯状態オプション定数 * @readonly * @enum {number} * @property {number} LED_STATE_OFF - 0:消灯 * @property {number} LED_STATE_ON_SOLID - 1:LED点灯（点灯しっぱなし） * @property {number} LED_STATE_ON_FLASH - 2:LED点滅（一定間隔で点滅） * @property {number} LED_STATE_ON_DIM - :3LEDがゆっくり明滅する */ static get cmdLed_LED_STATE(){ return{ 'LED_STATE_OFF':0, 'LED_STATE_ON_SOLID':1, 'LED_STATE_ON_FLASH':2, 'LED_STATE_ON_DIM':3 }; } /** * cmdCurveTypeの加減速カーブオプション定数 * @readonly * @enum {number} * @property {number} CURVE_TYPE_NONE - 0:モーションコントロール OFF * @property {number} CURVE_TYPE_TRAPEZOID - 1:モーションコントロール ON （台形加減速） */ static get cmdCurveType_CURVE_TYPE(){ return{ 'CURVE_TYPE_NONE': 0, 'CURVE_TYPE_TRAPEZOID':1 }; } /* * ReadRegisterで取得する時用のコマンド引数定数 * @readonly * @enum {number} * */ static get cmdReadRegister_COMMAND(){ return{ &quot;maxSpeed&quot;:0x02, &quot;minSpeed&quot;:0x03, &quot;curveType&quot;:0x05, &quot;acc&quot;:0x07, &quot;dec&quot;:0x08, &quot;maxTorque&quot;:0x0E, &quot;qCurrentP&quot;:0x18, &quot;qCurrentI&quot;:0x19, &quot;qCurrentD&quot;:0x1A, &quot;speedP&quot;:0x1B, &quot;speedI&quot;:0x1C, &quot;speedD&quot;:0x1D, &quot;positionP&quot;:0x1E, &quot;ownColor&quot;:0x3A }; } /** * constructor * @param {KMMotorCommandKMOne.KM_CONNECT_TYPE} connect_type 接続方式 * @param {object} kmcom 通信オブジェクト {@link KMComBLE} {@link KMComWebBLE} * @private */ constructor(connect_type,kmcom){ super(); /** * イベントタイプ定数 * @readonly * @enum {string} */ this.EVENT_TYPE={ /** 初期化完了時&lt;br&gt;return:function({KMDeviceInfo}) */ init:&quot;init&quot;, /** 接続時&lt;br&gt;return:function({KMDeviceInfo}) */ connect:&quot;connect&quot;, /** 切断時&lt;br&gt;return:function({KMDeviceInfo}) */ disconnect:&quot;disconnect&quot;, /** 接続に失敗時&lt;br&gt;return:function({KMDeviceInfo},{msg}) */ connectFailure:&quot;connectFailure&quot;, /** モーター回転情報受信時&lt;br&gt;return:function({@link KMRotState}) */ motorMeasurement:&quot;motorMeasurement&quot;, /** モーターIMU情報受信時&lt;br&gt;return:function({@link KMImuState}) */ imuMeasurement:&quot;imuMeasurement&quot; }; Object.freeze(this.EVENT_TYPE);//info::後からフリーズしないとjsdocが生成されない。 /** * モーターの全コマンド * @readonly * @enum {number} * @private */ this._MOTOR_COMMAND={ /** 最大速さを設定する */ maxSpeed:0x02, /** 最小速さを設定する */ minSpeed:0x03, /** 加減速曲線を設定する */ curveType:0x05, /** 加速度を設定する */ acc:0x07, /** 減速度を設定する */ dec:0x08, /** 最大トルクを設定する */ maxTorque:0x0E, /** q軸電流PIDゲイン(P)を設定する */ qCurrentP:0x18, /** q軸電流PIDゲイン(I)を設定する */ qCurrentI:0x19, /** q軸電流PIDゲイン(D)を設定する */ qCurrentD:0x1A, /** 速度PIDゲイン(P)を設定する */ speedP:0x1B, /** 速度PIDゲイン(I)を設定する */ speedI:0x1C, /** 速度PIDゲイン(D)を設定する */ speedD:0x1D, /** 位置PIDゲイン(P)を設定する */ positionP:0x1E, /** PIDゲインをリセットする */ resetPID:0x22, /** デバイスLEDの固有色を設定する */ ownColor:0x3A, /** 指定の設定値を取得する */ readRegister:0x40, /** 全ての設定値をフラッシュに保存する */ saveAllRegisters:0x41, /** 指定の設定値をリセットする */ resetRegister:0x4E, /** 全設定値をリセットする */ resetAllRegisters:0x4F, /** モーターの動作を不許可とする */ disable:0x50, /** モーター動作を許可する */ enable:0x51, /** 速度の大きさを設定する */ speed:0x58, /** 位置のプリセットを行う（原点設定） */ presetPosition:0x5A, /** 正回転する（反時計回り） */ runForward:0x60, /** 逆回転する（時計回り） */ runReverse:0x61, /** 絶対位置に移動する */ moveToPosition:0x66, /** 相対位置に移動する */ moveByDistance:0x68, /** モーターの励磁を停止する */ free:0x6C, /** 速度ゼロまで減速し停止する */ stop:0x6D, /** トルク制御を行う */ holdTorque:0x72, /** タスクセットを実行する */ doTaskset:0x81, /** モーション再生の開始地点に移動する */ preparePlaybackMotion:0x86, /** モーションを再生する */ startPlayback:0x87, /** モーション再生を停止する */ stopPlayback:0x88, /** キューを停止する */ pause:0x90, /** キューを再開する */ resume:0x91, /** キューを指定時間停止し再開する */ wait:0x92, /** キューをリセットする */ reset:0x95, /** タスクセットの記録を開始する */ startRecordingTaskset:0xA0, /** タスクセットの記録を停止する */ stopRecordingTaskset:0xA2, /** 指定のタスクセットを削除する */ eraseTaskset:0xA3, /** タスクセットを全削除する */ eraseAllTasksets:0xA4, /** ティーチングの開始準備を行う */ prepareTeachingMotion:0xAA, /** ティーチングを開始する */ startTeachingMotion:0xAB, /** ティーチングを停止する */ stopTeachingMotion:0xAC, /** ティーチングで覚えた動作を削除する */ eraseMotion:0xAD, /** ティーチングで覚えた全動作を削除する */ eraseAllMotion:0xAE, /** LEDの点灯状態をセットする */ led:0xE0, /** IMUの値取得(通知)を開始する */ enableIMU:0xEA, /** IMUの値取得(通知)を停止する */ disableIMU:0xEB, /** システムを再起動する */ reboot:0xF0, /** ファームウェアアップデートモードに入る */ enterDeviceFirmwareUpdate:0xFD }; Object.freeze(this._MOTOR_COMMAND);//info::後からフリーズしないとjsdocが生成されない。 //モーターの全コマンド（逆引用） this._REV_MOTOR_COMMAND={}; Object.keys(this._MOTOR_COMMAND).forEach((k)=&gt;{this._REV_MOTOR_COMMAND[this._MOTOR_COMMAND[k]]=k;}); //SendNotifyPromisのリスト this._notifyPromisList=[]; this.cmdPreparePlaybackMotion_START_POSITION=this.constructor.cmdPreparePlaybackMotion_START_POSITION; this.cmdLed_LED_STATE=this.constructor.cmdLed_LED_STATE; this.cmdCurveType_CURVE_TYPE=this.constructor.cmdCurveType_CURVE_TYPE; //-------------------------- // section::entry point //-------------------------- this._connectType=connect_type; this._KMCom=kmcom; //内部イベントバインド this._KMCom.onInit=(connector)=&gt;{ this.emit(this.EVENT_TYPE.init,connector.deviceInfo);//デバイス情報を返す }; this._KMCom.onConnect=(connector)=&gt;{ this.emit(this.EVENT_TYPE.connect,connector.deviceInfo); }; this._KMCom.onDisconnect=(connector)=&gt;{ this.emit(this.EVENT_TYPE.disconnect,connector.deviceInfo); }; this._KMCom.onConnectFailure=(connector, err)=&gt;{ this.emit(this.EVENT_TYPE.connectFailure,connector.deviceInfo,err); }; /** * モーター回転情報受信 * @param {{position:number,velocity:number,torque:number}} res * @private */ this._KMCom.onMotorMeasurement=(res)=&gt;{ let rotState=new KMStructures.KMRotState(res.position,res.velocity,res.torque); this.emit(this.EVENT_TYPE.motorMeasurement,rotState); }; /** * モーターIMU情報受信 * @param {function({accelX:number,accelY:number,accelZ:number,temp:number,gyroX:number,gyroY:number,gyroZ:number})} res * @private */ this._KMCom.onImuMeasurement=(res)=&gt;{ let imuState=new KMStructures.KMImuState(res.accelX,res.accelY,res.accelZ,res.temp,res.gyroX,res.gyroY,res.gyroZ); this.emit(this.EVENT_TYPE.imuMeasurement,imuState); }; /** * モーター設定情報取得 * @param {number} registerCmd * @param {number} res * @private */ this._KMCom._onMotorSettingCB=(registerCmd, res)=&gt;{ _KMNotifyPromis.sendGroupNotifyResolve(this._notifyPromisList,registerCmd,res); }; } /******************************************** * プロパティ ********************************************/ /** * モーターとのBLE接続が有効か * @readonly * @type {boolean} */ get isConnect(){ return this._KMCom.deviceInfo.isConnect; } /** * 接続方式 * @readonly * @type {KMMotorCommandKMOne.KM_CONNECT_TYPE} */ get connectType(){ return this._connectType; } /** * デバイス情報 * @readonly * @type {KMDeviceInfo} */ get deviceInfo(){ return this._KMCom.deviceInfo; } /** * 接続コネクター * @private * @type {KMComBLE} */ get connector(){ return this._KMCom; } /******************************************** * section::モーターコマンド https://document.keigan-motor.com/motor-control-command/motor_action.html ********************************************/ /** * @summary モーター動作を不許可とする（上位命令） * @desc 安全用：この命令を入れるとモーターは動作しない&lt;br&gt; * コマンドはタスクセットに記録することは不可 */ cmdDisable(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.disable); } /** * @summary モーター動作を許可する（上位命令） * @desc 安全用：この命令を入れるとモーターは動作可能となる&lt;br&gt; * モーター起動時は disable 状態のため、本コマンドで動作を許可する必要があり&lt;br&gt; * コマンドはタスクセットに記録することは不可 * */ cmdEnable(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.enable); } /** * @summary 速度の大きさをセットする（単位系：RPM） * @param {number} speed_rpm float [0-X rpm] (正の数) */ cmdSpeed_rpm(speed_rpm = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(speed_rpm*0.10471975511965977,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.speed,buffer); } /** * @summary 速度の大きさをセットする（単位系：ラジアン） * @param {number} speed float 速度の大きさ 単位：角度（ラジアン）/秒 [0-X rps] (正の数) */ cmdSpeed(speed = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(speed,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.speed,buffer); } /** * @summary 位置のプリセットを行う（原点設定）（単位系：ラジアン） * @param {number} position float 絶対角度：radians */ cmdPresetPosition(position = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,parseFloat(KMUtl.toNumber(position),10)); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.presetPosition,buffer); } /** * @summary 正回転する（反時計回り） * @desc cmdSpeed で保存された速度で、正回転 */ cmdRunForward(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.runForward); } /** * @summary 逆回転する（時計回り） * @desc cmdSpeed で保存された速度で、逆回転 */ cmdRunReverse(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.runReverse); } /** * @summary 絶対位置に移動する * @desc 速さは cmdSpeed で保存された速度が採用される * @param {number} position float 角度：radians */ cmdMoveToPosition(position){ if(position=== undefined){return;} let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,parseFloat(position,10)); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.moveToPosition,buffer); } /** * @summary 相対位置に移動する * @desc 速さは cmdSpeed で保存された速度が採用される * @param {number} distance float 角度：radians[左:+radians 右:-radians] */ cmdMoveByDistance(distance = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,parseFloat(distance,10)); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.moveByDistance,buffer); } /** * @summary モーターの励磁を停止する（感触は残ります） * @desc 完全フリー状態を再現する場合は、 cmdFree().cmdDisable() として下さい。 */ cmdFree(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.free); } /** * @summary モーターを速度ゼロまで減速し停止する * @desc rpm = 0 となる。 */ cmdStop(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.stop); } /** * @summary トルク制御を行う * @param {number} torque float トルク 単位：N・m [-X ~ + X Nm] 推奨値 0.3-0.05 * @desc 速度や位置を同時に制御する場合は、モーター設定の 0x0E: maxTorque と 0x60: runForward 等を併用して下さい。 * */ cmdHoldTorque(torque){ if(torque===undefined){return;} let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,parseFloat(torque,10)); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.holdTorque,buffer); } /** * @summary 記憶したタスク（命令）のセットを実行する * @param {number} index int タスクセット番号（0～65535） * @param {number} repeating int 繰り返し回数 0は無制限 * * @desc KM-1 は index: 0~49 まで。（50個のメモリバンク 各8128 Byte まで制限あり）&lt;br&gt; * タスクセットの記録は、コマンド（タスクセット）を参照下さい。 https://document.keigan-motor.com/motor-control-command/taskset.html */ cmdDoTaskset(index = 0,repeating = 1){ let buffer = new ArrayBuffer(6); new DataView(buffer).setUint16(0,Math.abs(parseInt(index,10))); new DataView(buffer).setUint32(2,Math.abs(parseInt(repeating,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.doTaskset,buffer); }; /** * @summary モーション再生の開始地点に移動する * @param {number} index int モーション番号（0～65535） * @param {number} repeating int 繰り返し回数 0は無制限 * @param {KMMotorCommandKMOne.cmdPreparePlaybackMotion_START_POSITION} start_position int スタート位置の設定&lt;br&gt; * START_POSITION_ABS:記憶された開始位置（絶対座標）からスタート&lt;br&gt; * START_POSITION_CURRENT:現在の位置を開始位置としてスタート * * * @desc KM-1 は index: 0~9 まで。（10個のメモリバンク。）それぞれ 約2分記録可能。&lt;br&gt; * ティーチング（動作の記録）は、コマンド（ティーチング）を参照下さい。&lt;br&gt;https://document.keigan-motor.com/motor-control-command/teaching.html&lt;br&gt; * * @todo repeating, option についてはファームウェア未実装 2017.10.10&lt;br&gt; * 再生回数は１回固定であり、本コマンドを実行すると、記録した絶対位置の最初のポイントに移動する */ cmdPreparePlaybackMotion(index = 0,repeating = 0,start_position = 0){ let buffer = new ArrayBuffer(7); new DataView(buffer).setUint16(0,Math.abs(parseInt(index,10))); new DataView(buffer).setUint32(2,Math.abs(parseInt(repeating,10))); new DataView(buffer).setUint8(6,Math.abs(parseInt(start_position,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.preparePlaybackMotion,buffer); } /** * @summary モーションを再生する */ cmdStartPlayback(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.startPlayback); } /** * @summary モーション再生を停止する */ cmdStopPlayback(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.stopPlayback); } //---------------------// // section::キュー操作 //---------------------// /** * @summary キューを一時停止する */ cmdPause(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.pause); } /** * @summary キューを再開する（蓄積されたタスクを再開） */ cmdResume(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.resume); } /** * @summary キューを指定時間停止し再開する * @desc cmdPause（キュー停止）を実行し、指定時間（ミリ秒）経過後、自動的に cmdResume（キュー再開） を行います。 * @param {number} time 停止時間[msec] */ cmdWait(time = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setUint32(0,Math.abs(parseInt(time,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.wait,buffer); } /** * @summary キューをリセットする */ cmdReset(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.reset); } //---------------------// // section::タスクセット //---------------------// /** * @summary タスク（命令）のセットの記録を開始する * @desc 記憶するインデックスのメモリはコマンド：eraseTaskset により予め消去されている必要があり * @param {number} index int インデックス KM-1 の場合、インデックスの値は 0～49 （計50個記録） */ cmdStartRecordingTaskSet(index = 0){ let buffer = new ArrayBuffer(2); new DataView(buffer).setUint16(0,Math.abs(parseInt(index,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.startRecordingTaskset,buffer); } /** * @summary タスクセットの記録を停止する * @desc startRecordingTaskset 実施中のみ有効 */ cmdStopRecordingTaskset(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.stopRecordingTaskset); } /** * @summary 指定のインデックスのタスクセットを消去する * @param {number} index int インデックス */ cmdEraseTaskset(index = 0){ let buffer = new ArrayBuffer(2); new DataView(buffer).setUint16(0,Math.abs(parseInt(index,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.eraseTaskset,buffer); } /** * @summary 全てのタスクセットを消去する */ cmdEraseAllTaskset(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.eraseAllTasksets); } //---------------------// // section::ティーチング //---------------------// /** * @summary インデックスと記録時間[msec]を指定し、ティーチングの開始準備を行う。 * @param {number} index int インデックス * @param {number} time int 記録時間 [msec 0-65408] * * @desc KM-1 の場合、インデックスの値は 0～9 （計10個記録）となる。記録時間は 65408 [msec] を超えることはできない * 記憶するインデックスのメモリはbleEraseMotion により予め消去されている必要がある * */ cmdPrepareTeachingMotion(index = 0,lengthRecordingTime = 30000){ let buffer = new ArrayBuffer(6); new DataView(buffer).setUint16(0,Math.abs(parseInt(index,10))); new DataView(buffer).setUint32(2,Math.abs(parseInt(lengthRecordingTime,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.prepareTeachingMotion,buffer); } /** * @summary 直前に行った prepareTeachingMotion の条件でティーチングを開始する。 * blePrepareTeachingMotion を実行した直後のみ有効。 */ cmdStartTeachingMotion(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.startTeachingMotion); } /** * @summary 実行中のティーチングを停止する */ cmdStopTeachingMotion(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.stopTeachingMotion); } /** * @summary 指定したインデックスのモーションを消去する * @param {number} index int インデックス * * @desc KM-1 の場合、インデックスの値は 0～9 （計10個記録）となる * */ cmdEraseMotion(index = 0){ let buffer = new ArrayBuffer(2); new DataView(buffer).setUint16(0,Math.abs(parseInt(index,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.eraseMotion,buffer); } /** * @summary 全てのモーションを消去する */ cmdEraseAllMotion(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.eraseAllMotion); } //---------------------// // section::LED //---------------------// /** * @summary LEDの点灯状態をセットする * @param {KMMotorCommandKMOne.cmdLed_LED_STATE} cmdLed_LED_STATE int 点灯状態&lt;br&gt; * LED_STATE_OFF:LED消灯&lt;br&gt; * LED_STATE_ON_SOLID:LED点灯&lt;br&gt; * LED_STATE_ON_FLASH:LED点滅（一定間隔で点滅）&lt;br&gt; * LED_STATE_ON_DIM:LEDがゆっくり明滅する * @param {number} red int 0-255 * @param {number} green int 0-255 * @param {number} blue int 0-255 */ cmdLed(cmdLed_LED_STATE,red,green,blue){ let buffer = new ArrayBuffer(4); new DataView(buffer).setUint8(0,Math.abs(parseInt(cmdLed_LED_STATE,10))); new DataView(buffer).setUint8(1,Math.abs(parseInt(red,10))); new DataView(buffer).setUint8(2,Math.abs(parseInt(green,10))); new DataView(buffer).setUint8(3,Math.abs(parseInt(blue,10))); this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.led,buffer); } //---------------------// // IMU ジャイロ //---------------------// /** * @summary IMU(ジャイロ)の値取得(通知)を開始する (BLE専用コマンド) * * @desc 本コマンドを実行すると、IMUのデータはBLEのキャラクタリスティクスMOTOR_IMU_MEASUREMENTに通知される&lt;br&gt; * MOTOR_IMU_MEASUREMENTのnotifyはイベントタイプ KMMotorCommandKMOne.EVENT_TYPE.imuMeasurement に通知 */ cmdEnableIMU(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.enableIMU); } /** * @summary IMU(ジャイロ)の値取得(通知)を停止する */ cmdDisableIMU(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.disableIMU); } //---------------------// // システム //---------------------// /** * @summary システムを再起動する * @desc BLEに接続していた場合、切断してから再起動 */ cmdReboot(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.reboot); } /** * @summary ファームウェアアップデートモードに入る * @desc ファームウェアをアップデートするためのブートローダーモードに入る。（システムは再起動される。） */ cmdEnterDeviceFirmwareUpdate(){ this._KMCom._sendMotorCommand('MOTOR_CONTROL',this._MOTOR_COMMAND.enterDeviceFirmwareUpdate); } //---------------------// // モーター設定 MOTOR_SETTING //---------------------// /** * @summary モーターの最大速さを設定する * @param {number} maxSpeed float 最大速さ [radian / second]（正の値） */ cmdMaxSpeed(maxSpeed){ if(maxSpeed===undefined){return;} let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(maxSpeed,10)));//todo::NaNが返る可能性 parseFloat(&quot;aaa&quot;,10)===NaN this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.maxSpeed,buffer); } /** * @summary モーターの最小速さを設定する * @param {number} maxSpeed float 最小速さ [radian / second]（正の値） * @desc minSpeed は、blePreparePlaybackMotion 実行の際、開始地点に移動する速さとして使用される。通常時運転では使用されない。 */ cmdMinSpeed(minSpeed){ if(minSpeed===undefined){return;} let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(minSpeed,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.minSpeed,buffer); } /** * @summary 加減速曲線を指定する（モーションコントロールの設定） * @param {KMMotorCommandKMOne.cmdCurveType_CURVE_TYPE} cmdCurveType_CURVE_TYPE int 加減速カーブオプション&lt;br&gt; * CURVE_TYPE_NONE:0 モーションコントロール OFF&lt;br&gt; * CURVE_TYPE_TRAPEZOID:1 モーションコントロール ON （台形加減速） */ cmdCurveType(cmdCurveType_CURVE_TYPE = 0){ let buffer = new ArrayBuffer(1); new DataView(buffer).setUint8(0,Math.abs(parseInt(cmdCurveType_CURVE_TYPE,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.curveType,buffer); } /** * @summary モーターの加速度を設定する * @param {number} acc float 加速度 0-200 [radian / second^2]（正の値） * @desc acc は、モーションコントロール ON の場合、加速時に使用されます。（加速時の直線の傾き） */ cmdAcc(acc = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(acc,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.acc,buffer); } /** * @summary モーターの減速度を設定する * @param {number} dec float 減速度 0-200 [radian / second^2]（正の値） * @desc dec は、モーションコントロール ON の場合、減速時に使用されます。（減速時の直線の傾き） */ cmdDec(dec = 0){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(dec,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.dec,buffer); } /** * @summary モーターの最大トルク（絶対値）を設定する * @param {number} maxTorque float 最大トルク [N*m]（正の値） * * @desc maxTorque を設定することにより、トルクの絶対値が maxTorque を超えないように運転します。&lt;br&gt; * maxTorque = 0.1 [N*m] の後に runForward （正回転）を行った場合、0.1 N*m を超えないようにその速度をなるだけ維持する。&lt;br&gt; * ただし、トルクの最大値制限により、システムによっては制御性（振動）が悪化する可能性がある。 * */ cmdMaxTorque(maxTorque){ if(maxTorque===undefined){return;} let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(maxTorque,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.maxTorque,buffer); } /** * @summary モーターのq軸電流PIDコントローラのP（比例）ゲインを設定する * @param {number} qCurrentP float q電流Pゲイン（正の値） */ cmdQCurrentP(qCurrentP){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(qCurrentP,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.qCurrentP,buffer); } /** * @summary モーターのq軸電流PIDコントローラのP（比例）ゲインを設定する * @param {number} qCurrentI float q電流Iゲイン（正の値） */ cmdQCurrentI(qCurrentI){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(qCurrentI,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.qCurrentI,buffer); } /** * @summary モーターのq軸電流PIDコントローラのD（微分）ゲインを設定する * @param {number} qCurrentD float q電流Dゲイン（正の値） */ cmdQCurrentD(qCurrentD){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(qCurrentD,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.qCurrentD,buffer); } /** * @summary モーターのq軸電流PIDコントローラのD（微分）ゲインを設定する * @param {number} speedP float 速度Pゲイン（正の値） */ cmdSpeedP(speedP){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(speedP,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.speedP,buffer); } /** * @summary モーターの速度PIDコントローラのI（積分）ゲインを設定する * @param {number} speedI float 速度Iゲイン（正の値） */ cmdSpeedI(speedI){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(speedI,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.speedI,buffer); } /** * @summary モーターの速度PIDコントローラのD（微分）ゲインを設定する * @param {number} speedD float 速度Dゲイン（正の値） */ cmdSpeedD(speedD){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(speedD,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.speedD,buffer); } /** * @summary モーターの位置PIDコントローラのP（比例）ゲインを設定する * @param {number} positionP float 位置Pゲイン（正の値） */ cmdPositionP(positionP){ let buffer = new ArrayBuffer(4); new DataView(buffer).setFloat32(0,Math.abs(parseFloat(positionP,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.positionP,buffer); } /** * @summary 全てのPIDパラメータをリセットしてファームウェアの初期設定に戻す * @desc qCurrentP, qCurrentI, qCurrentD, speedP, speedI, speedD, positionP をリセットします * */ cmdResetPID(){ this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.resetPID); } /** * @summary モーターの起動時固有LEDカラーを設定する * @param {number} red int 0-255 * @param {number} green int 0-255 * @param {number} blue int 0-255 * * @desc ownColor はアイドル時の固有LEDカラー。&lt;br&gt;saveAllSettingsを実行し、再起動後に初めて反映される。&lt;br&gt; * この設定値を変更した場合、BLEの Device Name の下3桁が変更される。 */ cmdOwnColor(red,green,blue){ let buffer = new ArrayBuffer(3); new DataView(buffer).setUint8(0,Math.abs(parseInt(red,10))); new DataView(buffer).setUint8(1,Math.abs(parseInt(green,10))); new DataView(buffer).setUint8(2,Math.abs(parseInt(blue,10))); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.ownColor,buffer); } /** * @summary 指定した設定値を取得 (BLE専用コマンド) * @param {number | array} registers &lt;int | []&gt; 取得するプロパティのコマンド(レジスタ番号)値 * @returns {Promise.&lt;int | array&gt;} 取得した値 &lt;br&gt;registersがint=レジスタ値のプリミティブ値 &lt;br&gt;registersがArray=レジスタ値のオブジェクト * * @none 取得する値はコマンド実行後にBLEのキャラクタリスティクスMOTOR_SETTINGに通知される。&lt;br&gt; * それを拾ってpromiseオブジェクトののresolveに返して処理を繋ぐ&lt;br&gt; * MOTOR_SETTINGのnotifyは_onBleMotorSettingで取得 */ cmdReadRegister(registers){ if(registers instanceof Array){ return new Promise((allresolve, allreject)=&gt; { var promiseList=[]; for(let i=0;i&lt;registers.length;i++){ let register=registers[i]; promiseList.push( new Promise((resolve, reject)=&gt; { let ccp=new _KMNotifyPromis(register,this._REV_MOTOR_COMMAND[register],this._notifyPromisList,resolve,reject,1000);//notify経由のresultをPromisと紐付け let buffer = new ArrayBuffer(1); new DataView(buffer).setUint8(0, parseInt(register, 10)); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.readRegister, buffer,ccp); })); } Promise.all(promiseList).then((resar)=&gt;{ let t=[{}].concat(resar); let rtobj=Object.assign.apply(null,t); allresolve(rtobj); }).catch((msg)=&gt;{ allreject(msg); }); }); }else{ return new Promise((lastresolve, lastreject)=&gt; { let register=registers; new Promise((resolve, reject)=&gt; { let ccp=new _KMNotifyPromis(register,this._REV_MOTOR_COMMAND[register],this._notifyPromisList,resolve,reject,1000);//notify経由のresultをPromisと紐付け let buffer = new ArrayBuffer(1); new DataView(buffer).setUint8(0, parseInt(register, 10)); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.readRegister, buffer,ccp); }).then((res)=&gt;{ lastresolve(res[Object.keys(res)[0]]); }).catch((msg)=&gt;{ lastreject(msg); }); }); } } /** * モーターの全てのレジスタ値の取得 * @returns {Promise.&lt;array&gt;} */ cmdReadAllRegister(){ let cm= this.constructor.cmdReadRegister_COMMAND; let allcmds=[]; Object.keys(cm).forEach((k)=&gt;{allcmds.push(cm[k]);}); return this.cmdReadRegister(allcmds); } //////保存 /** * @summary 全ての設定値をフラッシュメモリに保存する * @desc 本コマンドを実行しない限り、設定値はモーターに永久的に保存されない(再起動で消える) */ cmdSaveAllRegisters(){ this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.saveAllRegisters); } //////リセット /** * @summary 指定したレジスタをファームウェアの初期値にリセットする * @param {KMMotorCommandKMOne.cmdReadRegister_COMMAND} register 初期値にリセットするコマンド(レジスタ)値 */ cmdResetRegister(register){ let buffer = new ArrayBuffer(1); new DataView(buffer).setUint8(0,parseInt(register,10)); this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.resetRegister,buffer); } /** * @summary 全てのレジスタをファームウェアの初期値にリセットする * @desc bleSaveAllRegistersを実行しない限り、リセット値はモーターに永久的に保存されない(再起動で消える) */ cmdResetAllRegisters(){ this._KMCom._sendMotorCommand('MOTOR_SETTING',this._MOTOR_COMMAND.resetAllRegisters); } /******************************************** * 内部 ********************************************/ //////class// } /** * SendBleNotifyPromis * cmdReadRegister等のBLE呼び出し後に * コマンド結果がnotifyで通知されるコマンドをPromisと紐付ける為のクラス * @private */ class _KMNotifyPromis{ //成功通知 static sendGroupNotifyResolve(groupArray,tagName,val){ if(!groupArray instanceof Array){return;} //送信IDの通知 CallbackPromisで呼び出し元のメソッドのPromisに返す for(let i=0; i&lt;groupArray.length; i++){ if( groupArray[i].tagName===tagName ){ groupArray[i].callResolve(val); groupArray.splice(i,1); } } } /** * const * @param tagName * @param groupArray * @param promisResolveObj * @param promisRejectObj * @param rejectTimeOut */ constructor(tagName,tagInfo=null,groupArray=[],promisResolveObj, promisRejectObj,rejectTimeOut){ this.timeoutId=0; this.tagName=tagName; this.tagInfo=tagInfo; this.groupArray=groupArray instanceof Array?groupArray:[]; this.groupArray.push(this); this.promisResolveObj=promisResolveObj; this.promisRejectObj=promisRejectObj; this.rejectTimeOut=rejectTimeOut; } //カウントの開始 characteristics.writeValue呼び出し後に実行 startRejectTimeOutCount(){ this.timeoutId=setTimeout(()=&gt;{ this._removeGroup(); this.promisRejectObj({msg:&quot;timeout:&quot;,tagName:this.tagName,tagInfo:this.tagInfo}); }, this.rejectTimeOut); } callResolve(arg){ clearTimeout(this.timeoutId); this._removeGroup(); this.promisResolveObj(arg); } callReject(msg){ clearTimeout(this.timeoutId); this._removeGroup(); this.promisRejectObj({msg:msg}); } _removeGroup(){ for(let i=0; i&lt;this.groupArray.length; i++){ if( this.groupArray===this){ this.groupArray.splice(i,1); break; } } } } module.exports =KMMotorCommandKMOne; × Search results Close "},"KMMotorOneBLE.js.html":{"id":"KMMotorOneBLE.js.html","title":"Source: KMMotorOneBLE.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMMotorOneBLE.js /*** *KMMotorOneBLE.js * var 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let EventEmitter = require(&quot;events&quot;).EventEmitter; let KMComBLE = require('./KMComBLE'); let KMMotorCommandKMOne=require('./KMMotorCommandKMOne.js'); let noble = require('noble'); /** * @typedef {Object&lt; motorUUID,KMMotorOneBLE &gt;} _motorsByUUID * @ignore */ let _motorsByUUID={}; /** * @typedef {Object&lt; motorName,KMMotorOneBLE &gt;} _motorsByName * @ignore */ let _motorsByName={}; let _startScanTimeoutID=0; let _KMMotorOneBLEStaticEventEmitter=new EventEmitter(null); process.on('exit', function() { KMMotorOneBLE.allDisConnect(); }); /** * @classdesc KM-1のBLE接続用 仮想デバイス */ class KMMotorOneBLE extends KMMotorCommandKMOne{ /******************************************** * static events ********************************************/ /** * イベントリスナを追加する. Synonym for EventEmitter * @param {KMMotorOneBLE.EVENT_TYPE} type イベントのタイプ. * @param {function(object)} listener 追加するイベントリスナ. */ static on(type, listener){ _KMMotorOneBLEStaticEventEmitter.on(type,listener); } /** * 1回限りのイベントリスナを追加する. Synonym for EventEmitter * @param {KMMotorOneBLE.EVENT_TYPE} type イベントのタイプ. * @param {function(object)} listener 追加するイベントリスナ. */ static once(type, listener){ _KMMotorOneBLEStaticEventEmitter.once(type,listener); } /** * イベントリスナを削除する Synonym for EventEmitter * @param {KMMotorOneBLE.EVENT_TYPE} type イベントのタイプ * @param {function(object)} listener 削除するイベントリスナ */ static removeListener(type, listener){ _KMMotorOneBLEStaticEventEmitter.removeListener(type,listener); } /** * 全てのイベントリスナを削除する Synonym for EventEmitter * @param {KMMotorOneBLE.EVENT_TYPE} type イベントのタイプ. */ static removeAllListeners(type){ _KMMotorOneBLEStaticEventEmitter.removeAllListeners(type); } /** * イベントタイプ定数 * @readonly * @enum {string} * @property {string} discoverMotor - モーター発見時(毎回) * &lt;br&gt;return:function({@link KMMotorOneBLE}) * @property {string} discoverNewMotor - 新規モーターの発見時(1回のみ) * &lt;br&gt;return:function({@link KMMotorOneBLE}) * @property {string} scanTimeout - スキャンのタイムアウトで終了時 * &lt;br&gt;return:function() */ static get EVENT_TYPE(){ return { discoverMotor:&quot;discoverMotor&quot;, discoverNewMotor:&quot;discoverNewMotor&quot;, scanTimeout:&quot;scanTimeout&quot; }; } /******************************************** * static Scanning ********************************************/ /** * APIが認識しているモーターのインスタンスリスト(プロパティはモーター名) * &lt;br&gt;ex) {&lt;motorName1&gt;:{@link KMMotorOneBLE},&lt;motorName2&gt;:{@link KMMotorOneBLE},,,} * @readonly * @type {_motorsByName} */ static get motors(){ return _motorsByName; } /** * APIが認識しているモーターのインスタンスリスト(プロパティはUUID) * &lt;br&gt;ex) {&lt;motorUUID1&gt;:{@link KMMotorOneBLE},&lt;motorUUID2&gt;:{@link KMMotorOneBLE},,,} * @readonly * @type {_motorsByUUID} */ static get motorsByUUID(){ return _motorsByUUID; } /** * BLEデバイスのスキャンを開始し、検出したモーターを全てインスタンス化する * @param {number} time スキャンの継続時間(ms) */ static startScanToCreateInstance(time = 2000){ clearTimeout(_startScanTimeoutID); if(noble.state === 'poweredOn'){ noble.removeListener('discover',KMMotorOneBLE._discoverLis); noble.on('discover',KMMotorOneBLE._discoverLis); console.log('startScanToCreateInstance'); noble.startScanning([KMComBLE.MOTOR_BLE_SERVICE_UUID],false);//info::UUIDを指定しないとスキャン時にadvertisement.serviceUuidsが取得出来ない _startScanTimeoutID=setTimeout(()=&gt;{ KMMotorOneBLE.stopScan(); _KMMotorOneBLEStaticEventEmitter.emit(KMMotorOneBLE.EVENT_TYPE.scanTimeout); },time); }else if(noble.state === 'unknown') { noble.once('stateChange', function(){ KMMotorOneBLE.startScanToCreateInstance(); }); }else{ //BLE無効時 console.log('Could not start scanning, state is:'+noble.state); } } /** * BLEデバイスのスキャンの停止 */ static stopScan(){ noble.removeListener('discover',KMMotorOneBLE._discoverLis); if(noble.state === 'poweredOn') { noble.stopScanning(); console.log('stopScan'); } } /** * 全てのモーターのBLE接続を解除 */ static allDisConnect(){ Object.keys(_motorsByUUID).forEach((key)=&gt; { _motorsByUUID[key]._KMCom.disConnect(); }); _motorsByUUID={}; KMMotorOneBLE._restructMotorsByName(); } /** * 検出時リスナー * @param nobleperipheral * @private */ static _discoverLis(nobleperipheral){ //info::デバイスを選別する。startScanToCreateInstance中に別のクラスからnoble.startScanningした場合、Motor以外のデバイスも拾う可能性がある為。 if(!(nobleperipheral.advertisement&amp;&amp;nobleperipheral.advertisement.serviceUuids&amp;&amp;nobleperipheral.advertisement.serviceUuids[0]==KMComBLE.MOTOR_BLE_SERVICE_UUID)){ return; }; if(!_motorsByUUID[nobleperipheral.uuid]){ let motor= new KMMotorOneBLE(nobleperipheral);//info::検出したモーターは全てインスタンス化 _KMMotorOneBLEStaticEventEmitter.emit(KMMotorOneBLE.EVENT_TYPE.discoverNewMotor,_motorsByUUID[nobleperipheral.uuid]); } _KMMotorOneBLEStaticEventEmitter.emit(KMMotorOneBLE.EVENT_TYPE.discoverMotor,_motorsByUUID[nobleperipheral.uuid]); } /** * モーターのリストを再インデックス * @private */ static _restructMotorsByName(){ let list={}; Object.keys(_motorsByUUID).forEach((key)=&gt;{ let name= _motorsByUUID[key].deviceInfo.name? _motorsByUUID[key].deviceInfo.name.split('#')[0]:null; if(name){ list[name]=_motorsByUUID[key]; }else{ console.log('Err motor name not found'); } }); _motorsByName=list; } /******************************************** * instance Method ********************************************/ /** * KMMotorOneBLE * @constructor * @extends KMMotorCommandKMOne * @param {object} noblePeripheral noble Peripheralオブジェクト * @description 通常はstartScanToCreateInstance()メソッドから自動生成される為、単体では使用しない。&lt;br&gt; * モーター以外のデバイスの接続等でnoble APIをプログラム全体で使用している場合にnoblePeripheralと仮想モーターを関連付ける場合に使用。 */ constructor(noblePeripheral){ super(KMMotorCommandKMOne.KM_CONNECT_TYPE.BLE,new KMComBLE(noblePeripheral)); if(!_motorsByUUID[noblePeripheral.uuid]){ _motorsByUUID[noblePeripheral.uuid]=this; KMMotorOneBLE._restructMotorsByName(); } } /** * モーターと接続する */ connect(){ this._KMCom.connect(); } /** * モーターと切断 */ disConnect(){ this._KMCom.disConnect(); } } module.exports =KMMotorOneBLE; × Search results Close "},"KMMotorOneWebBLE.js.html":{"id":"KMMotorOneWebBLE.js.html","title":"Source: KMMotorOneWebBLE.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMMotorOneWebBLE.js /*** *KMMotorOneWebBLE.js * var 0.1.0 alpha * Created by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; let KMComWebBLE = require('./KMComWebBLE'); let KMMotorCommandKMOne=require('./KMMotorCommandKMOne.js'); /** * @classdesc KM-1のWebBluetooh接続用 仮想デバイス */ class KMMotorOneWebBLE extends KMMotorCommandKMOne{ /** * constructor * @extends KMMotorCommandKMOne */ constructor(){ super(KMMotorCommandKMOne.KM_CONNECT_TYPE.WEBBLE,new KMComWebBLE()); } /** * モーターと接続する */ connect(){ this._KMCom.connect(); } /** * モーターと切断 */ disConnect(){ this._KMCom.disConnect(); } } module.exports =KMMotorOneWebBLE; × Search results Close "},"KMUtl.js.html":{"id":"KMUtl.js.html","title":"Source: KMUtl.js","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Source: KMUtl.js /*** * KMUtl.js * version 0.1.0 alpha * CCreated by Harada Hiroshi on 2017/12/07. * * Copyright (c) 2017 Keigan Inc. https://keigan-motor.com/ * This software is released under the MIT License. * http://opensource.org/licenses/mit-license.php */ 'use strict'; /** * @classdesc ユーティリティ */ class KMUtl{ /** * 数値にキャストする関数 * 数値以外は0を返す&lt;br&gt; * Infinityも0とする * @param {number} val * @param {number} defaultval valが数値に変換出来ない場合のデフォルト * @returns {number} */ static toNumber(val, defaultval = 0) { let v = parseFloat(val, 10); return (isNaN(v) || val === Infinity ? defaultval : v); }; /** * 角度の単位変換 degree &gt;&gt; radian * @param {number} degree 度 * @returns {number} radian */ static degreeToRadian(degree) { return degree * 0.017453292519943295; }; /** * 角度の単位変換 radian &gt;&gt; degree * @param {number} radian radian角 * @returns {number} 度 */ static radianToDegree(radian) { return radian / 0.017453292519943295; }; /** * 速度 rpm -&gt;radian/sec に変換 * @param {number} rpm * @returns {number} radian/sec */ static rpmToRadianSec(rpm) { //速度 rpm -&gt;radian/sec(Math.PI*2/60) return rpm * 0.10471975511965977; }; /** * 2点間の距離と角度を求める * @param {number} from_x * @param {number} from_y * @param {number} to_x * @param {number} to_y * @returns {number} */ static twoPointDistanceAngle(from_x, from_y, to_x, to_y) { let distance = Math.sqrt(Math.pow(from_x - to_x, 2) + Math.pow(from_y - to_y, 2)); let radian = Math.atan2(from_y - to_y, from_x - to_x); return {dist: distance, radi: radian, deg: KMUtl.radianToDegree(radian)}; }; /** * @# info:: BLEのDEVICE INFORMATION SERVICEのパースにKMComBLE.jsで主に使用 * utf.js - UTF-8 &lt;=&gt; UTF-16 convertion * * @ignore * @param array * @returns {string} * @constructor * * @desc * Copyright (C) 1999 Masanao Izumo &lt;iz@onicos.co.jp&gt; * Version: 1.0 * LastModified: Dec 25 1999 * This library is free. You can redistribute it and/or modify it. */ static Utf8ArrayToStr(array) { let out, i, len, c; let char2, char3; out = &quot;&quot;; len = array.length; i = 0; while(i &lt; len) { c = array[i++]; switch(c &gt;&gt; 4) { case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7: // 0xxxxxxx out += String.fromCharCode(c); break; case 12: case 13: // 110x xxxx 10xx xxxx char2 = array[i++]; out += String.fromCharCode(((c &amp; 0x1F) &lt;&lt; 6) | (char2 &amp; 0x3F)); break; case 14: // 1110 xxxx 10xx xxxx 10xx xxxx char2 = array[i++]; char3 = array[i++]; out += String.fromCharCode(((c &amp; 0x0F) &lt;&lt; 12) | ((char2 &amp; 0x3F) &lt;&lt; 6) | ((char3 &amp; 0x3F) &lt;&lt; 0)); break; } } return out; }; } module.exports = KMUtl; × Search results Close "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Classes Classes KMMotorOneBLE KMMotorOneWebBLE KMImuState KMLedState KMRotState KMDeviceInfo KMUtl Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl KMConnectorNode.js and Browser javascript Library for Keigan Motor. Keigan Motor用のNode.jsとBrowser JavaScriptライブラリ DescriptionYou can control USB Serial and BLE in Node.js. Browser can control Web Bluetooth.https://www.keigan-motor.com/ Node.jsではUSBシリアル・BLE、ブラウザ(chrome)ではWebBluetoothを用いて接続出来ます。 DEMO: WebBluetooh (Browser only. Chrome on Android or Mac) WebBluetoothでのデモ(Android又はMac上のChromeで動作)https://document.keigan-motor.com/apiSample/kmconnector-js/sampleWebBle/Demo.html other exsample file is /examples/ サンプルファイルは/examples/にあります。 Requirement noble 1.8+ Usage BLE (Node.js only. Raspberrypi needs to run with administrator privilege to launch Bluetooh.(sudo)) BLE Node.js用。RaspberryPiは管理者権限で実行する必要があります。 USB Serial (Node.js only)comming soon. 現在開発中。 Web Bluetooth (Browser only. andoroid or chrome on macos) Web Bluetoothは現在andoroid及びMacOSのchromeのみで動作します。 InstallationNode.jsnpmからインストール $ npm install kmconnectorBrowser(Web Bluetooth)ブラウザはhtmlのヘッダーにindexBrowser.jsを読み込んで下さい &lt;script src=&quot;kmconnector/indexBrowser.js&quot;&gt;&lt;/script&gt;ExamplesBLEBLEでの接続例。サンプルファイルはexamples/nodejs/ let KMConnector = require('kmconnector'); KMConnector.KMMotorOneBLE.on(KMConnector.KMMotorOneBLE.EVENT_TYPE.discoverNewMotor,function(kMMotorOneBLE){ KMConnector.KMMotorOneBLE.stopScan(); kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.init,function(kMDeviceInfo){ if(kMMotorOneBLE.isConnect){ kMMotorOneBLE.cmdLed(1,200,0,0); } }); kMMotorOneBLE.connect(); }); KMConnector.KMMotorOneBLE.startScanToCreateInstance();Exsample file is /examples/nodejs/ BLE (When directly using noble API)BLE通信(noble)を既に使用している物に組み込む場合の例 let noble = require('noble'); noble.on('discover',(nobleperipheral)=&gt;{ noble.stopScanning(); //connected to motor only let localName=nobleperipheral.advertisement?nobleperipheral.advertisement.localName:&quot;&quot;; if(localName.startsWith('KM-1')){ let kMMotorOneBLE= new KMConnector.KMMotorOneBLE(nobleperipheral); kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.init,function(kMDeviceInfo){ if(kMMotorOneBLE.isConnect){ kMMotorOneBLE.cmdLed(1,200,0,0); } }); kMMotorOneBLE.connect(); } }); if(noble.state === 'poweredOn'){ noble.startScanning(); }else{ noble.once('stateChange',()=&gt;{ noble.startScanning(); }); }Web Bluetooth (Browser only. Chrome on Android or Mac)Web Bluetoothでの例。 サンプルファイルは/examples/browser_webbluetooh/ html&lt;head&gt; &lt;script src=&quot;kmconnector/indexBrowser.js&quot;&gt;&lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;a href=&quot;javascript:KMB.connect();&quot;&gt;connect&lt;/a&gt; &lt;/body&gt;javascriptlet KMB=new KMMotorOneWebBLE(); KMB.on(KMB.EVENT_TYPE.init,function(kMDeviceInfo){ KMB.cmdEnable(); KMB.cmdSpeed_rpm(10); KMB.cmdRunForward(); }); //KMB.connect();//For security reasons permission request error occurs unless it is ignited by user's click operationExsample file is /examples/browser_webbluetooh/ Https(https://) connection is required for Web Bluetooth operation. ※Web Bluetoothはセキュリティの為、https://での接続が必須です BLE connection Api (Node.js) Node.jsでのBLE接続例MethodsBLE Scanninng and Stopping (Static Methods) BLEスキャンと停止KMConnector.KMMotorOneBLE.startScanToCreateInstance(15000); KMConnector.KMMotorOneBLE.stopScan();Collective disconnection (Static Methods) 接続したモーターの全切断 KMConnector.KMMotorOneBLE.allDisConnect();Connect and disConnect(instance Methods) 個々のモーターの切断kMMotorOneBLE.connect(); kMMotorOneBLE.disConnect();Events(Scan)discoverMotor (Static) スキャン中のモーター発見時のイベント例KMConnector.KMMotorOneBLE.on(KMConnector.KMMotorOneBLE.EVENT_TYPE.discoverMotor,function(kMMotorOneBLE){ console.log('onDiscoverMotor:'+kMMotorOneBLE.deviceInfo.name); });discoverNewMotor (Static) 未接続の新規モーター発見時Only when new motor is found. KMConnector.KMMotorOneBLE.on(KMConnector.KMMotorOneBLE.EVENT_TYPE.discoverNewMotor,function(kMMotorOneBLE){ KMConnector.KMMotorOneBLE.stopScan();//Depending on the adapter, it is necessary to initialize the motor after completing the scan. https://github.com/sandeepmistry/noble#notes //todo::Motor initialization processing });scanTimeout (Static) スキャンがタイムアウトで終了した時KMConnector.KMMotorOneBLE.on(KMConnector.KMMotorOneBLE.EVENT_TYPE.scanTimeout,function(){ //Connected to all motors Object.keys(KMConnector.KMMotorOneBLE.motors).forEach((key)=&gt;{ let motor=KMConnector.KMMotorOneBLE.motors[key]; if(!motor.isConnect){ motor.connect(); } }); });Events(Motors)init モーターの初期化完了時のイベント例 kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.init,function(kMDeviceInfo){ //Motor operation kMMotorOneBLE.cmdEnable(); kMMotorOneBLE.cmdSpeed_rpm(10); kMMotorOneBLE.cmdRunForward(); });Connect and disconnect モーター接続・切断時イベントkMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.connect,function(kMDeviceInfo){ console.log(&quot;onConnect:&quot;+kMDeviceInfo.isConnect); }); kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.disconnect,function(kMDeviceInfo){ console.log(&quot;onDisconnect:&quot;+kMDeviceInfo.isConnect); }); kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.connectFailure,function(kMDeviceInfo,err){ console.log(&quot;onConnectFailure:&quot;+err); });motorMeasurement モーター回転情報受信時kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.motorMeasurement,function(kMRotState){ console.log(kMRotState.GetValObj());//{position,velocity,torque} });imuMeasurement ジャイロ情報受信時(受信するには別途cmdEnableIMU()を有効にする)It is output only when the gyro is enabled (kMMotorOneBLE.cmdEnableIMU()) kMMotorOneBLE.on(kMMotorOneBLE.EVENT_TYPE.imuMeasurement,function(kMImuState){ console.log(kMImuState.GetValObj());//{accelX,accelY,accelZ,temp,gyroX,gyroY,gyroZ} });Web Bluetooth Api (Browser) ブラウザでの接続例MethodsConnect and disConnect 接続・切断kMMotorOneWebBLE.connect() kMMotorOneWebBLE.disConnect()Events Node.jsと同様initWhen the motor is first connected and initialized kMMotorOneWebBLE.on(KMB.EVENT_TYPE.init,function(kMDeviceInfo){ console.log(kMDeviceInfo.GetValObj());//{type,id,name,isConnect,manufacturerName,firmwareRevision} kMMotorOneWebBLE.cmdEnable();//For safety, the motor operation at startup is disabled kMMotorOneWebBLE.cmdSpeed_rpm(10); });Connect and disconnectkMMotorOneWebBLE.on(KMB.EVENT_TYPE.connect,function(kMDeviceInfo){ console.log(&quot;onConnect:&quot;+kMDeviceInfo.isConnect); }); kMMotorOneWebBLE.on(KMB.EVENT_TYPE.disconnect,function(kMDeviceInfo){ console.log(&quot;onDisconnect:&quot;+kMDeviceInfo.isConnect); }); kMMotorOneWebBLE.on(KMB.EVENT_TYPE.connectFailure,function(kMDeviceInfo,err){ console.log(&quot;onConnectFailure:&quot;+err); });motorMeasurementkMMotorOneWebBLE.on(KMB.EVENT_TYPE.motorMeasurement,function(kMRotState){ console.log(kMRotState.GetValObj());//{position,velocity,torque} });imuMeasurementIt is output only when the gyro is enabled (kMMotorOneWebBLE.cmdEnableIMU()) kMMotorOneWebBLE.on(KMB.EVENT_TYPE.imuMeasurement,function(kMImuState){ console.log(kMImuState.GetValObj());//{accelX,accelY,accelZ,temp,gyroX,gyroY,gyroZ} });Motor command Api (common) モーター操作コマンドThe command of the motor is defined by &quot;cmd [CommandName] (prame, ...)&quot; 操作コマンドは「cmdコマンド名()」の書式になります。 kMMotorOneBLE.cmdSpeed_rpm(10);//Set the speed 10rpm kMMotorOneBLE.cmdEnable();//Enable motor action kMMotorOneBLE.cmdRunForward();//Run forward (ccw)For details of the command, see the following site詳細なドキュメント Motor command Api(English)https://en.document.keigan-motor.com/motor-control-command/command-motor-action.html KeiganMotor javascript Libraryリファレンス(日本語)https://document.keigan-motor.com/apiDocument/kmconnector-js/ モーターコマンド一覧https://document.keigan-motor.com/motor-control-command AuthorKeigan Inc. LicenseMIT Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMMotorOneBLE.html":{"id":"KMMotorOneBLE.html","title":"Class: KMMotorOneBLE","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMMotorOneBLE KMMotorOneBLE KM-1のBLE接続用 仮想デバイス new KMMotorOneBLE(noblePeripheral) 通常はstartScanToCreateInstance()メソッドから自動生成される為、単体では使用しない。モーター以外のデバイスの接続等でnoble APIをプログラム全体で使用している場合にnoblePeripheralと仮想モーターを関連付ける場合に使用。 Parameters: Name Type Description noblePeripheral object noble Peripheralオブジェクト Source: KMMotorOneBLE.js, line 40 Members &lt;static, readonly&gt; EVENT_TYPE :string イベントタイプ定数 Type: string Properties: Name Type Description discoverMotor string モーター発見時(毎回)return:function(KMMotorOneBLE) discoverNewMotor string 新規モーターの発見時(1回のみ)return:function(KMMotorOneBLE) scanTimeout string スキャンのタイムアウトで終了時return:function() Source: KMMotorOneBLE.js, line 88 &lt;static, readonly&gt; motors :_motorsByName APIが認識しているモーターのインスタンスリスト(プロパティはモーター名)ex) {:KMMotorOneBLE,:KMMotorOneBLE,,,} Type: _motorsByName Source: KMMotorOneBLE.js, line 106 &lt;static, readonly&gt; motorsByUUID :_motorsByUUID APIが認識しているモーターのインスタンスリスト(プロパティはUUID)ex) {:KMMotorOneBLE,:KMMotorOneBLE,,,} Type: _motorsByUUID Source: KMMotorOneBLE.js, line 116 &lt;readonly&gt; EVENT_TYPE :string イベントタイプ定数 Type: string Properties: Name Type Default Description init string init 初期化完了時return:function({KMDeviceInfo}) connect string connect 接続時return:function({KMDeviceInfo}) disconnect string disconnect 切断時return:function({KMDeviceInfo}) connectFailure string connectFailure 接続に失敗時return:function({KMDeviceInfo},{msg}) motorMeasurement string motorMeasurement モーター回転情報受信時return:function(KMRotState) imuMeasurement string imuMeasurement モーターIMU情報受信時return:function(KMImuState) Inherited From: KMMotorCommandKMOne#EVENT_TYPE Source: KMMotorCommandKMOne.js, line 119 &lt;readonly&gt; isConnect :boolean モーターとのBLE接続が有効か Type: boolean Inherited From: KMMotorCommandKMOne#isConnect Source: KMMotorCommandKMOne.js, line 253 &lt;readonly&gt; connectType :KMMotorCommandKMOne.KM_CONNECT_TYPE 接続方式 Type: KMMotorCommandKMOne.KM_CONNECT_TYPE Inherited From: KMMotorCommandKMOne#connectType Source: KMMotorCommandKMOne.js, line 261 &lt;readonly&gt; deviceInfo :KMDeviceInfo デバイス情報 Type: KMDeviceInfo Inherited From: KMMotorCommandKMOne#deviceInfo Source: KMMotorCommandKMOne.js, line 270 Methods &lt;static&gt; on(type, listener) イベントリスナを追加する. Synonym for EventEmitter Parameters: Name Type Description type KMMotorOneBLE.EVENT_TYPE イベントのタイプ. listener function 追加するイベントリスナ. Source: KMMotorOneBLE.js, line 49 &lt;static&gt; once(type, listener) 1回限りのイベントリスナを追加する. Synonym for EventEmitter Parameters: Name Type Description type KMMotorOneBLE.EVENT_TYPE イベントのタイプ. listener function 追加するイベントリスナ. Source: KMMotorOneBLE.js, line 57 &lt;static&gt; removeListener(type, listener) イベントリスナを削除する Synonym for EventEmitter Parameters: Name Type Description type KMMotorOneBLE.EVENT_TYPE イベントのタイプ listener function 削除するイベントリスナ Source: KMMotorOneBLE.js, line 65 &lt;static&gt; removeAllListeners(type) 全てのイベントリスナを削除する Synonym for EventEmitter Parameters: Name Type Description type KMMotorOneBLE.EVENT_TYPE イベントのタイプ. Source: KMMotorOneBLE.js, line 72 &lt;static&gt; startScanToCreateInstance(time) BLEデバイスのスキャンを開始し、検出したモーターを全てインスタンス化する Parameters: Name Type Default Description time number 2000 スキャンの継続時間(ms) Source: KMMotorOneBLE.js, line 123 &lt;static&gt; stopScan() BLEデバイスのスキャンの停止 Source: KMMotorOneBLE.js, line 147 &lt;static&gt; allDisConnect() 全てのモーターのBLE接続を解除 Source: KMMotorOneBLE.js, line 158 connect() モーターと接続する Source: KMMotorOneBLE.js, line 221 disConnect() モーターと切断 Source: KMMotorOneBLE.js, line 228 cmdDisable() モーター動作を不許可とする（上位命令） 安全用：この命令を入れるとモーターは動作しないコマンドはタスクセットに記録することは不可 Inherited From: KMMotorCommandKMOne#cmdDisable Source: KMMotorCommandKMOne.js, line 292 cmdEnable() モーター動作を許可する（上位命令） 安全用：この命令を入れるとモーターは動作可能となるモーター起動時は disable 状態のため、本コマンドで動作を許可する必要がありコマンドはタスクセットに記録することは不可 Inherited From: KMMotorCommandKMOne#cmdEnable Source: KMMotorCommandKMOne.js, line 303 cmdSpeed_rpm(speed_rpm) 速度の大きさをセットする（単位系：RPM） Parameters: Name Type Default Description speed_rpm number 0 float [0-X rpm] (正の数) Inherited From: KMMotorCommandKMOne#cmdSpeed_rpm Source: KMMotorCommandKMOne.js, line 310 cmdSpeed(speed) 速度の大きさをセットする（単位系：ラジアン） Parameters: Name Type Default Description speed number 0 float 速度の大きさ 単位：角度（ラジアン）/秒 [0-X rps] (正の数) Inherited From: KMMotorCommandKMOne#cmdSpeed Source: KMMotorCommandKMOne.js, line 319 cmdPresetPosition(position) 位置のプリセットを行う（原点設定）（単位系：ラジアン） Parameters: Name Type Default Description position number 0 float 絶対角度：radians Inherited From: KMMotorCommandKMOne#cmdPresetPosition Source: KMMotorCommandKMOne.js, line 329 cmdRunForward() 正回転する（反時計回り） cmdSpeed で保存された速度で、正回転 Inherited From: KMMotorCommandKMOne#cmdRunForward Source: KMMotorCommandKMOne.js, line 339 cmdRunReverse() 逆回転する（時計回り） cmdSpeed で保存された速度で、逆回転 Inherited From: KMMotorCommandKMOne#cmdRunReverse Source: KMMotorCommandKMOne.js, line 347 cmdMoveToPosition(position) 絶対位置に移動する 速さは cmdSpeed で保存された速度が採用される Parameters: Name Type Description position number float 角度：radians Inherited From: KMMotorCommandKMOne#cmdMoveToPosition Source: KMMotorCommandKMOne.js, line 356 cmdMoveByDistance(distance) 相対位置に移動する 速さは cmdSpeed で保存された速度が採用される Parameters: Name Type Default Description distance number 0 float 角度：radians[左:+radians 右:-radians] Inherited From: KMMotorCommandKMOne#cmdMoveByDistance Source: KMMotorCommandKMOne.js, line 368 cmdFree() モーターの励磁を停止する（感触は残ります） 完全フリー状態を再現する場合は、 cmdFree().cmdDisable() として下さい。 Inherited From: KMMotorCommandKMOne#cmdFree Source: KMMotorCommandKMOne.js, line 378 cmdStop() モーターを速度ゼロまで減速し停止する rpm = 0 となる。 Inherited From: KMMotorCommandKMOne#cmdStop Source: KMMotorCommandKMOne.js, line 386 cmdHoldTorque(torque) トルク制御を行う 速度や位置を同時に制御する場合は、モーター設定の 0x0E: maxTorque と 0x60: runForward 等を併用して下さい。 Parameters: Name Type Description torque number float トルク 単位：N・m [-X ~ + X Nm] 推奨値 0.3-0.05 Inherited From: KMMotorCommandKMOne#cmdHoldTorque Source: KMMotorCommandKMOne.js, line 397 cmdDoTaskset(index, repeating) 記憶したタスク（命令）のセットを実行する KM-1 は index: 0~49 まで。（50個のメモリバンク 各8128 Byte まで制限あり）タスクセットの記録は、コマンド（タスクセット）を参照下さい。 https://document.keigan-motor.com/motor-control-command/taskset.html Parameters: Name Type Default Description index number 0 int タスクセット番号（0～65535） repeating number 1 int 繰り返し回数 0は無制限 Inherited From: KMMotorCommandKMOne#cmdDoTaskset Source: KMMotorCommandKMOne.js, line 412 cmdPreparePlaybackMotion(index, repeating, start_position) モーション再生の開始地点に移動する KM-1 は index: 0~9 まで。（10個のメモリバンク。）それぞれ 約2分記録可能。ティーチング（動作の記録）は、コマンド（ティーチング）を参照下さい。https://document.keigan-motor.com/motor-control-command/teaching.html Parameters: Name Type Default Description index number 0 int モーション番号（0～65535） repeating number 0 int 繰り返し回数 0は無制限 start_position KMMotorCommandKMOne.cmdPreparePlaybackMotion_START_POSITION 0 int スタート位置の設定START_POSITION_ABS:記憶された開始位置（絶対座標）からスタートSTART_POSITION_CURRENT:現在の位置を開始位置としてスタート Inherited From: KMMotorCommandKMOne#cmdPreparePlaybackMotion Source: KMMotorCommandKMOne.js, line 434 To Do: repeating, option についてはファームウェア未実装 2017.10.10 再生回数は１回固定であり、本コマンドを実行すると、記録した絶対位置の最初のポイントに移動する cmdStartPlayback() モーションを再生する Inherited From: KMMotorCommandKMOne#cmdStartPlayback Source: KMMotorCommandKMOne.js, line 445 cmdStopPlayback() モーション再生を停止する Inherited From: KMMotorCommandKMOne#cmdStopPlayback Source: KMMotorCommandKMOne.js, line 452 cmdPause() キューを一時停止する Inherited From: KMMotorCommandKMOne#cmdPause Source: KMMotorCommandKMOne.js, line 462 cmdResume() キューを再開する（蓄積されたタスクを再開） Inherited From: KMMotorCommandKMOne#cmdResume Source: KMMotorCommandKMOne.js, line 469 cmdWait(time) キューを指定時間停止し再開する cmdPause（キュー停止）を実行し、指定時間（ミリ秒）経過後、自動的に cmdResume（キュー再開） を行います。 Parameters: Name Type Default Description time number 0 停止時間[msec] Inherited From: KMMotorCommandKMOne#cmdWait Source: KMMotorCommandKMOne.js, line 478 cmdReset() キューをリセットする Inherited From: KMMotorCommandKMOne#cmdReset Source: KMMotorCommandKMOne.js, line 487 cmdStartRecordingTaskSet(index) タスク（命令）のセットの記録を開始する 記憶するインデックスのメモリはコマンド：eraseTaskset により予め消去されている必要があり Parameters: Name Type Default Description index number 0 int インデックス KM-1 の場合、インデックスの値は 0～49 （計50個記録） Inherited From: KMMotorCommandKMOne#cmdStartRecordingTaskSet Source: KMMotorCommandKMOne.js, line 500 cmdStopRecordingTaskset() タスクセットの記録を停止する startRecordingTaskset 実施中のみ有効 Inherited From: KMMotorCommandKMOne#cmdStopRecordingTaskset Source: KMMotorCommandKMOne.js, line 510 cmdEraseTaskset(index) 指定のインデックスのタスクセットを消去する Parameters: Name Type Default Description index number 0 int インデックス Inherited From: KMMotorCommandKMOne#cmdEraseTaskset Source: KMMotorCommandKMOne.js, line 518 cmdEraseAllTaskset() 全てのタスクセットを消去する Inherited From: KMMotorCommandKMOne#cmdEraseAllTaskset Source: KMMotorCommandKMOne.js, line 527 cmdPrepareTeachingMotion(index, time) インデックスと記録時間[msec]を指定し、ティーチングの開始準備を行う。 KM-1 の場合、インデックスの値は 0～9 （計10個記録）となる。記録時間は 65408 [msec] を超えることはできない 記憶するインデックスのメモリはbleEraseMotion により予め消去されている必要がある Parameters: Name Type Default Description index number 0 int インデックス time number int 記録時間 [msec 0-65408] Inherited From: KMMotorCommandKMOne#cmdPrepareTeachingMotion Source: KMMotorCommandKMOne.js, line 544 cmdStartTeachingMotion() 直前に行った prepareTeachingMotion の条件でティーチングを開始する。blePrepareTeachingMotion を実行した直後のみ有効。 Inherited From: KMMotorCommandKMOne#cmdStartTeachingMotion Source: KMMotorCommandKMOne.js, line 555 cmdStopTeachingMotion() 実行中のティーチングを停止する Inherited From: KMMotorCommandKMOne#cmdStopTeachingMotion Source: KMMotorCommandKMOne.js, line 562 cmdEraseMotion(index) 指定したインデックスのモーションを消去する KM-1 の場合、インデックスの値は 0～9 （計10個記録）となる Parameters: Name Type Default Description index number 0 int インデックス Inherited From: KMMotorCommandKMOne#cmdEraseMotion Source: KMMotorCommandKMOne.js, line 573 cmdEraseAllMotion() 全てのモーションを消去する Inherited From: KMMotorCommandKMOne#cmdEraseAllMotion Source: KMMotorCommandKMOne.js, line 582 cmdLed(cmdLed_LED_STATE, red, green, blue) LEDの点灯状態をセットする Parameters: Name Type Description cmdLed_LED_STATE KMMotorCommandKMOne.cmdLed_LED_STATE int 点灯状態 LED_STATE_OFF:LED消灯 LED_STATE_ON_SOLID:LED点灯 LED_STATE_ON_FLASH:LED点滅（一定間隔で点滅） LED_STATE_ON_DIM:LEDがゆっくり明滅する red number int 0-255 green number int 0-255 blue number int 0-255 Inherited From: KMMotorCommandKMOne#cmdLed Source: KMMotorCommandKMOne.js, line 600 cmdEnableIMU() IMU(ジャイロ)の値取得(通知)を開始する (BLE専用コマンド) 本コマンドを実行すると、IMUのデータはBLEのキャラクタリスティクスMOTOR_IMU_MEASUREMENTに通知されるMOTOR_IMU_MEASUREMENTのnotifyはイベントタイプ KMMotorCommandKMOne.EVENT_TYPE.imuMeasurement に通知 Inherited From: KMMotorCommandKMOne#cmdEnableIMU Source: KMMotorCommandKMOne.js, line 618 cmdDisableIMU() IMU(ジャイロ)の値取得(通知)を停止する Inherited From: KMMotorCommandKMOne#cmdDisableIMU Source: KMMotorCommandKMOne.js, line 625 cmdReboot() システムを再起動する BLEに接続していた場合、切断してから再起動 Inherited From: KMMotorCommandKMOne#cmdReboot Source: KMMotorCommandKMOne.js, line 636 cmdEnterDeviceFirmwareUpdate() ファームウェアアップデートモードに入る ファームウェアをアップデートするためのブートローダーモードに入る。（システムは再起動される。） Inherited From: KMMotorCommandKMOne#cmdEnterDeviceFirmwareUpdate Source: KMMotorCommandKMOne.js, line 644 cmdMaxSpeed(maxSpeed) モーターの最大速さを設定する Parameters: Name Type Description maxSpeed number float 最大速さ [radian / second]（正の値） Inherited From: KMMotorCommandKMOne#cmdMaxSpeed Source: KMMotorCommandKMOne.js, line 655 cmdMinSpeed(maxSpeed) モーターの最小速さを設定する minSpeed は、blePreparePlaybackMotion 実行の際、開始地点に移動する速さとして使用される。通常時運転では使用されない。 Parameters: Name Type Description maxSpeed number float 最小速さ [radian / second]（正の値） Inherited From: KMMotorCommandKMOne#cmdMinSpeed Source: KMMotorCommandKMOne.js, line 667 cmdCurveType(cmdCurveType_CURVE_TYPE) 加減速曲線を指定する（モーションコントロールの設定） Parameters: Name Type Default Description cmdCurveType_CURVE_TYPE KMMotorCommandKMOne.cmdCurveType_CURVE_TYPE 0 int 加減速カーブオプション CURVE_TYPE_NONE:0 モーションコントロール OFF CURVE_TYPE_TRAPEZOID:1 モーションコントロール ON （台形加減速） Inherited From: KMMotorCommandKMOne#cmdCurveType Source: KMMotorCommandKMOne.js, line 680 cmdAcc(acc) モーターの加速度を設定する acc は、モーションコントロール ON の場合、加速時に使用されます。（加速時の直線の傾き） Parameters: Name Type Default Description acc number 0 float 加速度 0-200 [radian / second^2]（正の値） Inherited From: KMMotorCommandKMOne#cmdAcc Source: KMMotorCommandKMOne.js, line 691 cmdDec(dec) モーターの減速度を設定する dec は、モーションコントロール ON の場合、減速時に使用されます。（減速時の直線の傾き） Parameters: Name Type Default Description dec number 0 float 減速度 0-200 [radian / second^2]（正の値） Inherited From: KMMotorCommandKMOne#cmdDec Source: KMMotorCommandKMOne.js, line 702 cmdMaxTorque(maxTorque) モーターの最大トルク（絶対値）を設定する maxTorque を設定することにより、トルクの絶対値が maxTorque を超えないように運転します。maxTorque = 0.1 [Nm] の後に runForward （正回転）を行った場合、0.1 Nm を超えないようにその速度をなるだけ維持する。ただし、トルクの最大値制限により、システムによっては制御性（振動）が悪化する可能性がある。 Parameters: Name Type Description maxTorque number float 最大トルク [N*m]（正の値） Inherited From: KMMotorCommandKMOne#cmdMaxTorque Source: KMMotorCommandKMOne.js, line 717 cmdQCurrentP(qCurrentP) モーターのq軸電流PIDコントローラのP（比例）ゲインを設定する Parameters: Name Type Description qCurrentP number float q電流Pゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdQCurrentP Source: KMMotorCommandKMOne.js, line 728 cmdQCurrentI(qCurrentI) モーターのq軸電流PIDコントローラのP（比例）ゲインを設定する Parameters: Name Type Description qCurrentI number float q電流Iゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdQCurrentI Source: KMMotorCommandKMOne.js, line 738 cmdQCurrentD(qCurrentD) モーターのq軸電流PIDコントローラのD（微分）ゲインを設定する Parameters: Name Type Description qCurrentD number float q電流Dゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdQCurrentD Source: KMMotorCommandKMOne.js, line 748 cmdSpeedP(speedP) モーターのq軸電流PIDコントローラのD（微分）ゲインを設定する Parameters: Name Type Description speedP number float 速度Pゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdSpeedP Source: KMMotorCommandKMOne.js, line 758 cmdSpeedI(speedI) モーターの速度PIDコントローラのI（積分）ゲインを設定する Parameters: Name Type Description speedI number float 速度Iゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdSpeedI Source: KMMotorCommandKMOne.js, line 768 cmdSpeedD(speedD) モーターの速度PIDコントローラのD（微分）ゲインを設定する Parameters: Name Type Description speedD number float 速度Dゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdSpeedD Source: KMMotorCommandKMOne.js, line 778 cmdPositionP(positionP) モーターの位置PIDコントローラのP（比例）ゲインを設定する Parameters: Name Type Description positionP number float 位置Pゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdPositionP Source: KMMotorCommandKMOne.js, line 788 cmdResetPID() 全てのPIDパラメータをリセットしてファームウェアの初期設定に戻す qCurrentP, qCurrentI, qCurrentD, speedP, speedI, speedD, positionP をリセットします Inherited From: KMMotorCommandKMOne#cmdResetPID Source: KMMotorCommandKMOne.js, line 799 cmdOwnColor(red, green, blue) モーターの起動時固有LEDカラーを設定する ownColor はアイドル時の固有LEDカラー。saveAllSettingsを実行し、再起動後に初めて反映される。この設定値を変更した場合、BLEの Device Name の下3桁が変更される。 Parameters: Name Type Description red number int 0-255 green number int 0-255 blue number int 0-255 Inherited From: KMMotorCommandKMOne#cmdOwnColor Source: KMMotorCommandKMOne.js, line 812 cmdReadRegister(registers) 指定した設定値を取得 (BLE専用コマンド) Parameters: Name Type Description registers number | array 取得するプロパティのコマンド(レジスタ番号)値 Inherited From: KMMotorCommandKMOne#cmdReadRegister Source: KMMotorCommandKMOne.js, line 831 Returns: 取得した値 registersがint=レジスタ値のプリミティブ値 registersがArray=レジスタ値のオブジェクト Type Promise.&lt;(int|array)&gt; cmdReadAllRegister() モーターの全てのレジスタ値の取得 Inherited From: KMMotorCommandKMOne#cmdReadAllRegister Source: KMMotorCommandKMOne.js, line 873 Returns: Type Promise.&lt;array&gt; cmdSaveAllRegisters() 全ての設定値をフラッシュメモリに保存する 本コマンドを実行しない限り、設定値はモーターに永久的に保存されない(再起動で消える) Inherited From: KMMotorCommandKMOne#cmdSaveAllRegisters Source: KMMotorCommandKMOne.js, line 885 cmdResetRegister(register) 指定したレジスタをファームウェアの初期値にリセットする Parameters: Name Type Description register KMMotorCommandKMOne.cmdReadRegister_COMMAND 初期値にリセットするコマンド(レジスタ)値 Inherited From: KMMotorCommandKMOne#cmdResetRegister Source: KMMotorCommandKMOne.js, line 894 cmdResetAllRegisters() 全てのレジスタをファームウェアの初期値にリセットする bleSaveAllRegistersを実行しない限り、リセット値はモーターに永久的に保存されない(再起動で消える) Inherited From: KMMotorCommandKMOne#cmdResetAllRegisters Source: KMMotorCommandKMOne.js, line 903 Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMMotorOneWebBLE.html":{"id":"KMMotorOneWebBLE.html","title":"Class: KMMotorOneWebBLE","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMMotorOneWebBLE KMMotorOneWebBLE KM-1のWebBluetooh接続用 仮想デバイス new KMMotorOneWebBLE() constructor Source: KMMotorOneWebBLE.js, line 18 Members &lt;readonly&gt; EVENT_TYPE :string イベントタイプ定数 Type: string Properties: Name Type Default Description init string init 初期化完了時return:function({KMDeviceInfo}) connect string connect 接続時return:function({KMDeviceInfo}) disconnect string disconnect 切断時return:function({KMDeviceInfo}) connectFailure string connectFailure 接続に失敗時return:function({KMDeviceInfo},{msg}) motorMeasurement string motorMeasurement モーター回転情報受信時return:function(KMRotState) imuMeasurement string imuMeasurement モーターIMU情報受信時return:function(KMImuState) Inherited From: KMMotorCommandKMOne#EVENT_TYPE Source: KMMotorCommandKMOne.js, line 119 &lt;readonly&gt; isConnect :boolean モーターとのBLE接続が有効か Type: boolean Inherited From: KMMotorCommandKMOne#isConnect Source: KMMotorCommandKMOne.js, line 253 &lt;readonly&gt; connectType :KMMotorCommandKMOne.KM_CONNECT_TYPE 接続方式 Type: KMMotorCommandKMOne.KM_CONNECT_TYPE Inherited From: KMMotorCommandKMOne#connectType Source: KMMotorCommandKMOne.js, line 261 &lt;readonly&gt; deviceInfo :KMDeviceInfo デバイス情報 Type: KMDeviceInfo Inherited From: KMMotorCommandKMOne#deviceInfo Source: KMMotorCommandKMOne.js, line 270 Methods connect() モーターと接続する Source: KMMotorOneWebBLE.js, line 30 disConnect() モーターと切断 Source: KMMotorOneWebBLE.js, line 37 cmdDisable() モーター動作を不許可とする（上位命令） 安全用：この命令を入れるとモーターは動作しないコマンドはタスクセットに記録することは不可 Inherited From: KMMotorCommandKMOne#cmdDisable Source: KMMotorCommandKMOne.js, line 292 cmdEnable() モーター動作を許可する（上位命令） 安全用：この命令を入れるとモーターは動作可能となるモーター起動時は disable 状態のため、本コマンドで動作を許可する必要がありコマンドはタスクセットに記録することは不可 Inherited From: KMMotorCommandKMOne#cmdEnable Source: KMMotorCommandKMOne.js, line 303 cmdSpeed_rpm(speed_rpm) 速度の大きさをセットする（単位系：RPM） Parameters: Name Type Default Description speed_rpm number 0 float [0-X rpm] (正の数) Inherited From: KMMotorCommandKMOne#cmdSpeed_rpm Source: KMMotorCommandKMOne.js, line 310 cmdSpeed(speed) 速度の大きさをセットする（単位系：ラジアン） Parameters: Name Type Default Description speed number 0 float 速度の大きさ 単位：角度（ラジアン）/秒 [0-X rps] (正の数) Inherited From: KMMotorCommandKMOne#cmdSpeed Source: KMMotorCommandKMOne.js, line 319 cmdPresetPosition(position) 位置のプリセットを行う（原点設定）（単位系：ラジアン） Parameters: Name Type Default Description position number 0 float 絶対角度：radians Inherited From: KMMotorCommandKMOne#cmdPresetPosition Source: KMMotorCommandKMOne.js, line 329 cmdRunForward() 正回転する（反時計回り） cmdSpeed で保存された速度で、正回転 Inherited From: KMMotorCommandKMOne#cmdRunForward Source: KMMotorCommandKMOne.js, line 339 cmdRunReverse() 逆回転する（時計回り） cmdSpeed で保存された速度で、逆回転 Inherited From: KMMotorCommandKMOne#cmdRunReverse Source: KMMotorCommandKMOne.js, line 347 cmdMoveToPosition(position) 絶対位置に移動する 速さは cmdSpeed で保存された速度が採用される Parameters: Name Type Description position number float 角度：radians Inherited From: KMMotorCommandKMOne#cmdMoveToPosition Source: KMMotorCommandKMOne.js, line 356 cmdMoveByDistance(distance) 相対位置に移動する 速さは cmdSpeed で保存された速度が採用される Parameters: Name Type Default Description distance number 0 float 角度：radians[左:+radians 右:-radians] Inherited From: KMMotorCommandKMOne#cmdMoveByDistance Source: KMMotorCommandKMOne.js, line 368 cmdFree() モーターの励磁を停止する（感触は残ります） 完全フリー状態を再現する場合は、 cmdFree().cmdDisable() として下さい。 Inherited From: KMMotorCommandKMOne#cmdFree Source: KMMotorCommandKMOne.js, line 378 cmdStop() モーターを速度ゼロまで減速し停止する rpm = 0 となる。 Inherited From: KMMotorCommandKMOne#cmdStop Source: KMMotorCommandKMOne.js, line 386 cmdHoldTorque(torque) トルク制御を行う 速度や位置を同時に制御する場合は、モーター設定の 0x0E: maxTorque と 0x60: runForward 等を併用して下さい。 Parameters: Name Type Description torque number float トルク 単位：N・m [-X ~ + X Nm] 推奨値 0.3-0.05 Inherited From: KMMotorCommandKMOne#cmdHoldTorque Source: KMMotorCommandKMOne.js, line 397 cmdDoTaskset(index, repeating) 記憶したタスク（命令）のセットを実行する KM-1 は index: 0~49 まで。（50個のメモリバンク 各8128 Byte まで制限あり）タスクセットの記録は、コマンド（タスクセット）を参照下さい。 https://document.keigan-motor.com/motor-control-command/taskset.html Parameters: Name Type Default Description index number 0 int タスクセット番号（0～65535） repeating number 1 int 繰り返し回数 0は無制限 Inherited From: KMMotorCommandKMOne#cmdDoTaskset Source: KMMotorCommandKMOne.js, line 412 cmdPreparePlaybackMotion(index, repeating, start_position) モーション再生の開始地点に移動する KM-1 は index: 0~9 まで。（10個のメモリバンク。）それぞれ 約2分記録可能。ティーチング（動作の記録）は、コマンド（ティーチング）を参照下さい。https://document.keigan-motor.com/motor-control-command/teaching.html Parameters: Name Type Default Description index number 0 int モーション番号（0～65535） repeating number 0 int 繰り返し回数 0は無制限 start_position KMMotorCommandKMOne.cmdPreparePlaybackMotion_START_POSITION 0 int スタート位置の設定START_POSITION_ABS:記憶された開始位置（絶対座標）からスタートSTART_POSITION_CURRENT:現在の位置を開始位置としてスタート Inherited From: KMMotorCommandKMOne#cmdPreparePlaybackMotion Source: KMMotorCommandKMOne.js, line 434 To Do: repeating, option についてはファームウェア未実装 2017.10.10 再生回数は１回固定であり、本コマンドを実行すると、記録した絶対位置の最初のポイントに移動する cmdStartPlayback() モーションを再生する Inherited From: KMMotorCommandKMOne#cmdStartPlayback Source: KMMotorCommandKMOne.js, line 445 cmdStopPlayback() モーション再生を停止する Inherited From: KMMotorCommandKMOne#cmdStopPlayback Source: KMMotorCommandKMOne.js, line 452 cmdPause() キューを一時停止する Inherited From: KMMotorCommandKMOne#cmdPause Source: KMMotorCommandKMOne.js, line 462 cmdResume() キューを再開する（蓄積されたタスクを再開） Inherited From: KMMotorCommandKMOne#cmdResume Source: KMMotorCommandKMOne.js, line 469 cmdWait(time) キューを指定時間停止し再開する cmdPause（キュー停止）を実行し、指定時間（ミリ秒）経過後、自動的に cmdResume（キュー再開） を行います。 Parameters: Name Type Default Description time number 0 停止時間[msec] Inherited From: KMMotorCommandKMOne#cmdWait Source: KMMotorCommandKMOne.js, line 478 cmdReset() キューをリセットする Inherited From: KMMotorCommandKMOne#cmdReset Source: KMMotorCommandKMOne.js, line 487 cmdStartRecordingTaskSet(index) タスク（命令）のセットの記録を開始する 記憶するインデックスのメモリはコマンド：eraseTaskset により予め消去されている必要があり Parameters: Name Type Default Description index number 0 int インデックス KM-1 の場合、インデックスの値は 0～49 （計50個記録） Inherited From: KMMotorCommandKMOne#cmdStartRecordingTaskSet Source: KMMotorCommandKMOne.js, line 500 cmdStopRecordingTaskset() タスクセットの記録を停止する startRecordingTaskset 実施中のみ有効 Inherited From: KMMotorCommandKMOne#cmdStopRecordingTaskset Source: KMMotorCommandKMOne.js, line 510 cmdEraseTaskset(index) 指定のインデックスのタスクセットを消去する Parameters: Name Type Default Description index number 0 int インデックス Inherited From: KMMotorCommandKMOne#cmdEraseTaskset Source: KMMotorCommandKMOne.js, line 518 cmdEraseAllTaskset() 全てのタスクセットを消去する Inherited From: KMMotorCommandKMOne#cmdEraseAllTaskset Source: KMMotorCommandKMOne.js, line 527 cmdPrepareTeachingMotion(index, time) インデックスと記録時間[msec]を指定し、ティーチングの開始準備を行う。 KM-1 の場合、インデックスの値は 0～9 （計10個記録）となる。記録時間は 65408 [msec] を超えることはできない 記憶するインデックスのメモリはbleEraseMotion により予め消去されている必要がある Parameters: Name Type Default Description index number 0 int インデックス time number int 記録時間 [msec 0-65408] Inherited From: KMMotorCommandKMOne#cmdPrepareTeachingMotion Source: KMMotorCommandKMOne.js, line 544 cmdStartTeachingMotion() 直前に行った prepareTeachingMotion の条件でティーチングを開始する。blePrepareTeachingMotion を実行した直後のみ有効。 Inherited From: KMMotorCommandKMOne#cmdStartTeachingMotion Source: KMMotorCommandKMOne.js, line 555 cmdStopTeachingMotion() 実行中のティーチングを停止する Inherited From: KMMotorCommandKMOne#cmdStopTeachingMotion Source: KMMotorCommandKMOne.js, line 562 cmdEraseMotion(index) 指定したインデックスのモーションを消去する KM-1 の場合、インデックスの値は 0～9 （計10個記録）となる Parameters: Name Type Default Description index number 0 int インデックス Inherited From: KMMotorCommandKMOne#cmdEraseMotion Source: KMMotorCommandKMOne.js, line 573 cmdEraseAllMotion() 全てのモーションを消去する Inherited From: KMMotorCommandKMOne#cmdEraseAllMotion Source: KMMotorCommandKMOne.js, line 582 cmdLed(cmdLed_LED_STATE, red, green, blue) LEDの点灯状態をセットする Parameters: Name Type Description cmdLed_LED_STATE KMMotorCommandKMOne.cmdLed_LED_STATE int 点灯状態 LED_STATE_OFF:LED消灯 LED_STATE_ON_SOLID:LED点灯 LED_STATE_ON_FLASH:LED点滅（一定間隔で点滅） LED_STATE_ON_DIM:LEDがゆっくり明滅する red number int 0-255 green number int 0-255 blue number int 0-255 Inherited From: KMMotorCommandKMOne#cmdLed Source: KMMotorCommandKMOne.js, line 600 cmdEnableIMU() IMU(ジャイロ)の値取得(通知)を開始する (BLE専用コマンド) 本コマンドを実行すると、IMUのデータはBLEのキャラクタリスティクスMOTOR_IMU_MEASUREMENTに通知されるMOTOR_IMU_MEASUREMENTのnotifyはイベントタイプ KMMotorCommandKMOne.EVENT_TYPE.imuMeasurement に通知 Inherited From: KMMotorCommandKMOne#cmdEnableIMU Source: KMMotorCommandKMOne.js, line 618 cmdDisableIMU() IMU(ジャイロ)の値取得(通知)を停止する Inherited From: KMMotorCommandKMOne#cmdDisableIMU Source: KMMotorCommandKMOne.js, line 625 cmdReboot() システムを再起動する BLEに接続していた場合、切断してから再起動 Inherited From: KMMotorCommandKMOne#cmdReboot Source: KMMotorCommandKMOne.js, line 636 cmdEnterDeviceFirmwareUpdate() ファームウェアアップデートモードに入る ファームウェアをアップデートするためのブートローダーモードに入る。（システムは再起動される。） Inherited From: KMMotorCommandKMOne#cmdEnterDeviceFirmwareUpdate Source: KMMotorCommandKMOne.js, line 644 cmdMaxSpeed(maxSpeed) モーターの最大速さを設定する Parameters: Name Type Description maxSpeed number float 最大速さ [radian / second]（正の値） Inherited From: KMMotorCommandKMOne#cmdMaxSpeed Source: KMMotorCommandKMOne.js, line 655 cmdMinSpeed(maxSpeed) モーターの最小速さを設定する minSpeed は、blePreparePlaybackMotion 実行の際、開始地点に移動する速さとして使用される。通常時運転では使用されない。 Parameters: Name Type Description maxSpeed number float 最小速さ [radian / second]（正の値） Inherited From: KMMotorCommandKMOne#cmdMinSpeed Source: KMMotorCommandKMOne.js, line 667 cmdCurveType(cmdCurveType_CURVE_TYPE) 加減速曲線を指定する（モーションコントロールの設定） Parameters: Name Type Default Description cmdCurveType_CURVE_TYPE KMMotorCommandKMOne.cmdCurveType_CURVE_TYPE 0 int 加減速カーブオプション CURVE_TYPE_NONE:0 モーションコントロール OFF CURVE_TYPE_TRAPEZOID:1 モーションコントロール ON （台形加減速） Inherited From: KMMotorCommandKMOne#cmdCurveType Source: KMMotorCommandKMOne.js, line 680 cmdAcc(acc) モーターの加速度を設定する acc は、モーションコントロール ON の場合、加速時に使用されます。（加速時の直線の傾き） Parameters: Name Type Default Description acc number 0 float 加速度 0-200 [radian / second^2]（正の値） Inherited From: KMMotorCommandKMOne#cmdAcc Source: KMMotorCommandKMOne.js, line 691 cmdDec(dec) モーターの減速度を設定する dec は、モーションコントロール ON の場合、減速時に使用されます。（減速時の直線の傾き） Parameters: Name Type Default Description dec number 0 float 減速度 0-200 [radian / second^2]（正の値） Inherited From: KMMotorCommandKMOne#cmdDec Source: KMMotorCommandKMOne.js, line 702 cmdMaxTorque(maxTorque) モーターの最大トルク（絶対値）を設定する maxTorque を設定することにより、トルクの絶対値が maxTorque を超えないように運転します。maxTorque = 0.1 [Nm] の後に runForward （正回転）を行った場合、0.1 Nm を超えないようにその速度をなるだけ維持する。ただし、トルクの最大値制限により、システムによっては制御性（振動）が悪化する可能性がある。 Parameters: Name Type Description maxTorque number float 最大トルク [N*m]（正の値） Inherited From: KMMotorCommandKMOne#cmdMaxTorque Source: KMMotorCommandKMOne.js, line 717 cmdQCurrentP(qCurrentP) モーターのq軸電流PIDコントローラのP（比例）ゲインを設定する Parameters: Name Type Description qCurrentP number float q電流Pゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdQCurrentP Source: KMMotorCommandKMOne.js, line 728 cmdQCurrentI(qCurrentI) モーターのq軸電流PIDコントローラのP（比例）ゲインを設定する Parameters: Name Type Description qCurrentI number float q電流Iゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdQCurrentI Source: KMMotorCommandKMOne.js, line 738 cmdQCurrentD(qCurrentD) モーターのq軸電流PIDコントローラのD（微分）ゲインを設定する Parameters: Name Type Description qCurrentD number float q電流Dゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdQCurrentD Source: KMMotorCommandKMOne.js, line 748 cmdSpeedP(speedP) モーターのq軸電流PIDコントローラのD（微分）ゲインを設定する Parameters: Name Type Description speedP number float 速度Pゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdSpeedP Source: KMMotorCommandKMOne.js, line 758 cmdSpeedI(speedI) モーターの速度PIDコントローラのI（積分）ゲインを設定する Parameters: Name Type Description speedI number float 速度Iゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdSpeedI Source: KMMotorCommandKMOne.js, line 768 cmdSpeedD(speedD) モーターの速度PIDコントローラのD（微分）ゲインを設定する Parameters: Name Type Description speedD number float 速度Dゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdSpeedD Source: KMMotorCommandKMOne.js, line 778 cmdPositionP(positionP) モーターの位置PIDコントローラのP（比例）ゲインを設定する Parameters: Name Type Description positionP number float 位置Pゲイン（正の値） Inherited From: KMMotorCommandKMOne#cmdPositionP Source: KMMotorCommandKMOne.js, line 788 cmdResetPID() 全てのPIDパラメータをリセットしてファームウェアの初期設定に戻す qCurrentP, qCurrentI, qCurrentD, speedP, speedI, speedD, positionP をリセットします Inherited From: KMMotorCommandKMOne#cmdResetPID Source: KMMotorCommandKMOne.js, line 799 cmdOwnColor(red, green, blue) モーターの起動時固有LEDカラーを設定する ownColor はアイドル時の固有LEDカラー。saveAllSettingsを実行し、再起動後に初めて反映される。この設定値を変更した場合、BLEの Device Name の下3桁が変更される。 Parameters: Name Type Description red number int 0-255 green number int 0-255 blue number int 0-255 Inherited From: KMMotorCommandKMOne#cmdOwnColor Source: KMMotorCommandKMOne.js, line 812 cmdReadRegister(registers) 指定した設定値を取得 (BLE専用コマンド) Parameters: Name Type Description registers number | array 取得するプロパティのコマンド(レジスタ番号)値 Inherited From: KMMotorCommandKMOne#cmdReadRegister Source: KMMotorCommandKMOne.js, line 831 Returns: 取得した値 registersがint=レジスタ値のプリミティブ値 registersがArray=レジスタ値のオブジェクト Type Promise.&lt;(int|array)&gt; cmdReadAllRegister() モーターの全てのレジスタ値の取得 Inherited From: KMMotorCommandKMOne#cmdReadAllRegister Source: KMMotorCommandKMOne.js, line 873 Returns: Type Promise.&lt;array&gt; cmdSaveAllRegisters() 全ての設定値をフラッシュメモリに保存する 本コマンドを実行しない限り、設定値はモーターに永久的に保存されない(再起動で消える) Inherited From: KMMotorCommandKMOne#cmdSaveAllRegisters Source: KMMotorCommandKMOne.js, line 885 cmdResetRegister(register) 指定したレジスタをファームウェアの初期値にリセットする Parameters: Name Type Description register KMMotorCommandKMOne.cmdReadRegister_COMMAND 初期値にリセットするコマンド(レジスタ)値 Inherited From: KMMotorCommandKMOne#cmdResetRegister Source: KMMotorCommandKMOne.js, line 894 cmdResetAllRegisters() 全てのレジスタをファームウェアの初期値にリセットする bleSaveAllRegistersを実行しない限り、リセット値はモーターに永久的に保存されない(再起動で消える) Inherited From: KMMotorCommandKMOne#cmdResetAllRegisters Source: KMMotorCommandKMOne.js, line 903 Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMImuState.html":{"id":"KMImuState.html","title":"Class: KMImuState","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMImuState KMImuState ジャイロセンサー値 new KMImuState(accelX, accelY, accelZ, temp, gyroX, gyroY, gyroZ) constructor Parameters: Name Type Description accelX number 加速度(x) [± 1] accelY number 加速度(y) [± 1] accelZ number 加速度(z) [± 1] temp number 温度 C gyroX number 角速度(x) [± 1] gyroY number 角速度(y) [± 1] gyroZ number 角速度(z) [± 1] Source: KMStructures.js, line 201 Methods EQ(tar) 同じ値を持つかの比較 Parameters: Name Type Description tar object 比較する構造体 Inherited From: KMStructureBase#EQ Source: KMStructures.js, line 26 Returns: 結果 Type boolean Clone() 複製 Inherited From: KMStructureBase#Clone Source: KMStructures.js, line 42 Returns: 複製された構造体 Type object GetValObj() 値の取得（Obj） Inherited From: KMStructureBase#GetValObj Source: KMStructures.js, line 49 Returns: Type object GetValArray() 値の取得（配列） Inherited From: KMStructureBase#GetValArray Source: KMStructures.js, line 57 Returns: Type Array Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMLedState.html":{"id":"KMLedState.html","title":"Class: KMLedState","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMLedState KMLedState モーターLED 点灯・色状態 new KMLedState(state, colorR, colorG, colorB) constructor Parameters: Name Type Description state KMLedState.MOTOR_LED_STATE colorR number int [0-255] colorG number int [0-255] colorB number int [0-255] Source: KMStructures.js, line 236 Members &lt;static, readonly&gt; MOTOR_LED_STATE :number モーターのLED状態 Type: number Properties: Name Type Description MOTOR_LED_STATE_OFF number 0:LED消灯 MOTOR_LED_STATE_ON_SOLID number 1:LED点灯 MOTOR_LED_STATE_ON_FLASH number 2:LED点滅（一定間隔で点滅） MOTOR_LED_STATE_ON_DIM number 3:LEDがゆっくり輝度変化する Source: KMStructures.js, line 246 Methods EQ(tar) 同じ値を持つかの比較 Parameters: Name Type Description tar object 比較する構造体 Inherited From: KMStructureBase#EQ Source: KMStructures.js, line 26 Returns: 結果 Type boolean Clone() 複製 Inherited From: KMStructureBase#Clone Source: KMStructures.js, line 42 Returns: 複製された構造体 Type object GetValObj() 値の取得（Obj） Inherited From: KMStructureBase#GetValObj Source: KMStructures.js, line 49 Returns: Type object GetValArray() 値の取得（配列） Inherited From: KMStructureBase#GetValArray Source: KMStructures.js, line 57 Returns: Type Array Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMRotState.html":{"id":"KMRotState.html","title":"Class: KMRotState","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMRotState KMRotState モーター回転情報 new KMRotState(position, velocity, torque) constructor Parameters: Name Type Description position number 座標 velocity number 速度 torque number トルク Source: KMStructures.js, line 276 Members &lt;static, readonly&gt; MAX_TORQUE :number 最大トルク定数 Type: number Source: KMStructures.js, line 282 &lt;static, readonly&gt; MAX_SPEED_RPM :number 最大速度定数(rpm) Type: number Source: KMStructures.js, line 291 &lt;static, readonly&gt; MAX_SPEED_RADIAN :number 最大速度定数(radian/sec) Type: number Source: KMStructures.js, line 299 &lt;static, readonly&gt; MAX_POSITION :number 最大座標定数 Type: number Source: KMStructures.js, line 307 Methods EQ(tar) 同じ値を持つかの比較 Parameters: Name Type Description tar object 比較する構造体 Inherited From: KMStructureBase#EQ Source: KMStructures.js, line 26 Returns: 結果 Type boolean Clone() 複製 Inherited From: KMStructureBase#Clone Source: KMStructures.js, line 42 Returns: 複製された構造体 Type object GetValObj() 値の取得（Obj） Inherited From: KMStructureBase#GetValObj Source: KMStructures.js, line 49 Returns: Type object GetValArray() 値の取得（配列） Inherited From: KMStructureBase#GetValArray Source: KMStructures.js, line 57 Returns: Type Array Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMDeviceInfo.html":{"id":"KMDeviceInfo.html","title":"Class: KMDeviceInfo","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMDeviceInfo KMDeviceInfo デバイス情報 new KMDeviceInfo(type, id, name, isConnect, manufacturerName, hardwareRevision, firmwareRevision) constructor Parameters: Name Type Default Description type KMMotorCommandKMOne.KM_CONNECT_TYPE 0 接続方式 id string デバイスUUID name string モーター名 isConnect boolean false 接続状態 manufacturerName string null 製造会社名 hardwareRevision string null firmwareRevision string null Source: KMStructures.js, line 333 Methods EQ(tar) 同じ値を持つかの比較 Parameters: Name Type Description tar object 比較する構造体 Inherited From: KMStructureBase#EQ Source: KMStructures.js, line 26 Returns: 結果 Type boolean Clone() 複製 Inherited From: KMStructureBase#Clone Source: KMStructures.js, line 42 Returns: 複製された構造体 Type object GetValObj() 値の取得（Obj） Inherited From: KMStructureBase#GetValObj Source: KMStructures.js, line 49 Returns: Type object GetValArray() 値の取得（配列） Inherited From: KMStructureBase#GetValArray Source: KMStructures.js, line 57 Returns: Type Array Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "},"KMUtl.html":{"id":"KMUtl.html","title":"Class: KMUtl","body":" KeiganMotor Javascript Library Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl Class: KMUtl KMUtl ユーティリティ new KMUtl() Source: KMUtl.js, line 15 Methods &lt;static&gt; toNumber(val, defaultval) 数値にキャストする関数数値以外は0を返すInfinityも0とする Parameters: Name Type Default Description val number defaultval number 0 valが数値に変換出来ない場合のデフォルト Source: KMUtl.js, line 25 Returns: Type number &lt;static&gt; degreeToRadian(degree) 角度の単位変換 degree &gt;&gt; radian Parameters: Name Type Description degree number 度 Source: KMUtl.js, line 35 Returns: radian Type number &lt;static&gt; radianToDegree(radian) 角度の単位変換 radian &gt;&gt; degree Parameters: Name Type Description radian number radian角 Source: KMUtl.js, line 44 Returns: 度 Type number &lt;static&gt; rpmToRadianSec(rpm) 速度 rpm -&gt;radian/sec に変換 Parameters: Name Type Description rpm number Source: KMUtl.js, line 53 Returns: radian/sec Type number &lt;static&gt; twoPointDistanceAngle(from_x, from_y, to_x, to_y) 2点間の距離と角度を求める Parameters: Name Type Description from_x number from_y number to_x number to_y number Source: KMUtl.js, line 65 Returns: Type number Classes KMMotorOneBLEKMMotorOneWebBLEKMImuStateKMLedStateKMRotStateKMDeviceInfoKMUtl × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
